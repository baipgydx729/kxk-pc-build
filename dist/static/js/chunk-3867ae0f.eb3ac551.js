(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3867ae0f"],{1605:function(e,t,a){"use strict";a("90ae")},"460d":function(e,t,a){"use strict";var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-dialog",{attrs:{title:"源单列表",visible:e.dialogVisible,width:"70%"},on:{"update:visible":function(t){e.dialogVisible=t}}},[a("div",{staticClass:"dflex-s padding-bottom"},[a("el-date-picker",{staticStyle:{width:"300px"},attrs:{type:"daterange","range-separator":" - ","start-placeholder":"开始日期","end-placeholder":"结束日期"},model:{value:e.reqData.dateRange,callback:function(t){e.$set(e.reqData,"dateRange",t)},expression:"reqData.dateRange"}}),a("el-input",{staticClass:"margin-left-sm",staticStyle:{width:"300px"},attrs:{placeholder:"请输入单号搜索",clearable:""},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.fetchDataList(t)}},model:{value:e.reqData.ordersNo,callback:function(t){e.$set(e.reqData,"ordersNo",t)},expression:"reqData.ordersNo"}}),a("el-button",{staticClass:"margin-left-sm",attrs:{type:"primary",icon:"el-icon-search"},on:{click:e.fetchDataList}},[e._v("查 询")])],1),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.dataLoading,expression:"dataLoading"}],staticClass:"aux-table",attrs:{data:e.dataList,border:""},on:{"selection-change":e.handleSelectionChange}},[a("el-table-column",{attrs:{type:"selection",width:"55",align:"center",selectable:e.selectableFunc}}),a("el-table-column",{attrs:{width:"220",align:"left",label:"订单号",fixed:""},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",{staticClass:"link-hover"},[e._v(e._s(t.row.orders_no))])]}}])}),a("el-table-column",{attrs:{width:"180",align:"left",label:"开单时间"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("formatDate")(t.row.orders_date)))])]}}])}),a("el-table-column",{attrs:{width:"120",align:"center",label:"业务类型"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("formatTypeName")(t.row.orders_type,e.$constant.ORDERS_TYPES)))])]}}])}),a("el-table-column",{attrs:{width:"120",align:"right",label:"应"+e.compDeitText+"金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("cent2yuan")(t.row.should_settle_money||t.row.orders_total_money||t.row.total_orders_money)))])]}}])}),a("el-table-column",{attrs:{width:"120",align:"right",label:"已"+e.compDeitText+"金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("cent2yuan")(t.row.settle_money)))])]}}])}),a("el-table-column",{attrs:{width:"120",align:"right",label:"待"+e.compDeitText+"金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",{staticClass:"ft-danger"},[e._v(e._s(e._f("cent2yuan")((t.row.should_settle_money||t.row.orders_total_money)-(t.row.settle_money||0))))])]}}])}),a("el-table-column",{attrs:{align:"left",label:"备注信息","show-overflow-tooltip":""},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(t.row.remark||t.row.orders_remark))]}}])})],1),a("div",{staticClass:"dflex-b padding-top-sm"},[a("div",[a("el-pagination",{attrs:{background:"","page-size":e.pagination.pageSize,total:e.pagination.totalCount,"current-page":e.pagination.pageNo,"page-sizes":[15,20],layout:"total, prev, pager, next"},on:{"current-change":e.changePageNo}})],1),a("div",{staticClass:"padding-bottom-sm"},[a("el-button",{attrs:{type:"primary",disabled:0==e.dataSelection.length},on:{click:e.submit}},[e._v("确认提交")]),a("el-button",{attrs:{type:"default"},on:{click:e.close}},[e._v("取消")])],1)])],1)},n=[],s=a("c7eb"),o=a("1da1"),l=(a("caad"),a("d81d"),a("2532"),a("2f46")),i=a.n(l),d=a("2197"),c={name:"OrdersListDialog",props:{ordersType:{type:String,default:"sales"},disabledList:{type:Array,default:[]},reqParams:{type:Object,default:function(){return{settleState:"unsettle",dateSort:"desc"}}}},data:function(){return{dialogVisible:!1,filterStates:[{name:"全部",value:""},{name:"待审核",value:0},{name:"待出库",value:1},{name:"待发货",value:2},{name:"待签收",value:3}],dataLoading:!1,dataList:[],dataSelection:[],pagination:{totalCount:1,pageSize:15,pageNo:1},reqData:{dateRange:[],ordersNo:"",state:[]}}},computed:{compDeitText:function(){return["sales","purchase-refund"].includes(this.ordersType)?"收":["sales-refund","purchase"].includes(this.ordersType)?"付":""}},methods:{fetchDataList:function(){var e=this;return Object(o["a"])(Object(s["a"])().mark((function t(){var a,r,n,o;return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:a=Object.assign(e.reqParams,e.reqData,e.pagination),r=e.reqData.dateRange||[],r.length>0&&(a.startDay=i()(r[0]).valueOf(),a.endDay=i()(r[1]).valueOf()),n={sales:"orders/listOrders","sales-refund":"orders/listRefundOrders",purchase:"purchase/listOrders","purchase-refund":"purchase/listRefundOrders"},o=n[e.ordersType],e.dataLoading=!0,Object(d["a"])(o,a,{functionName:"xunda"}).then((function(t){e.dataLoading=!1,e.dataList=(t.data||[]).map((function(t){return t.orders_type=e.ordersType,t})),1===e.pagination.pageNo&&(e.pagination.totalCount=t.totalCount)}));case 7:case"end":return t.stop()}}),t)})))()},changePageNo:function(e){this.pagination.pageNo=e,this.fetchDataList()},selectableFunc:function(e,t){return!1===this.disabledList.includes(e._id)},handleSelectionChange:function(e){this.dataSelection=e},submit:function(){0!==this.dataSelection.length&&(this.$emit("selection-submit",this.dataSelection),this.close())},open:function(){this.dialogVisible=!0,this.fetchDataList("refresh")},close:function(){this.dialogVisible=!1}}},u=c,m=(a("5008"),a("2877")),p=Object(m["a"])(u,r,n,!1,null,null,null);t["a"]=p.exports},5008:function(e,t,a){"use strict";a("5b2f")},"5b2f":function(e,t,a){},"7ce4":function(e,t,a){"use strict";a.r(t);var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"app-container"},[a("el-form",{ref:"elForm",attrs:{model:e.formData,rules:e.rules,"label-width":"110px"}},[a("div",{staticClass:"aux-card"},[a("div",{staticClass:"header"},[a("div",{staticClass:"left title"},[e._v("付款单")]),a("div",{staticClass:"right"},[a("el-button",{on:{click:e.resetForm}},[e._v("重置")]),a("el-button",{attrs:{type:"primary",icon:"el-icon-save"},on:{click:e.submitForm}},[e._v("保存提交")])],1)]),a("div",{staticClass:"padding"},[a("el-row",{attrs:{align:"top"}},[a("el-form-item",{attrs:{label:"收款方",prop:"payee_id"}},[a("div",{staticClass:"dflex-s"},[a("el-select",{staticStyle:{width:"160px"},attrs:{placeholder:"收款方类型"},on:{change:e.changePayeeType},model:{value:e.formData.payee_type,callback:function(t){e.$set(e.formData,"payee_type",t)},expression:"formData.payee_type"}},e._l(e.payeeTypes,(function(e){return a("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1),1==e.formData.payee_type?[a("AuxStoreSelect",{staticClass:"margin-left-sm",staticStyle:{width:"300px"},on:{change:e.changePayeeSelect},model:{value:e.formData.payee_id,callback:function(t){e.$set(e.formData,"payee_id",t)},expression:"formData.payee_id"}})]:e._e(),2==e.formData.payee_type?[a("AuxSupplierSelect",{staticClass:"margin-left-sm",staticStyle:{width:"300px"},on:{change:e.changePayeeSelect},model:{value:e.formData.payee_id,callback:function(t){e.$set(e.formData,"payee_id",t)},expression:"formData.payee_id"}})]:e._e()],2)]),a("el-form-item",{attrs:{label:"收款时间",prop:"payment_date"}},[a("el-date-picker",{staticStyle:{width:"300px"},attrs:{type:"datetime","value-format":"timestamp",placeholder:"选择收款时间"},model:{value:e.formData.payment_date,callback:function(t){e.$set(e.formData,"payment_date",t)},expression:"formData.payment_date"}})],1),a("el-form-item",{attrs:{label:"收款类型",prop:"settle_type"}},[a("el-select",{staticStyle:{width:"300px"},attrs:{placeholder:"收款类型"},on:{change:e.changeSettleType},model:{value:e.formData.settle_type,callback:function(t){e.$set(e.formData,"settle_type",t)},expression:"formData.settle_type"}},e._l(e.compSettleOrdersTypeList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1)],1),[20,11].includes(e.formData.settle_type)?a("el-form-item",{attrs:{label:"源单信息"}},[a("div",{staticStyle:{"line-height":"20px"}},[a("div",{staticClass:"padding-bottom-sm"},[a("el-button",{attrs:{type:"success",size:"mini",icon:"el-icon-plus"},on:{click:e.handleAddOrders}},[e._v("添加订单")])],1),a("el-table",{staticClass:"aux-table",attrs:{data:e.ordersList,border:"","show-summary":"","summary-method":e.summaryMethod}},[a("el-table-column",{attrs:{width:"60",align:"center",label:"#"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{type:"default",size:"mini",icon:"el-icon-minus",circle:""},on:{click:function(a){return e.removeItem(t.row,t.$index)}}})]}}],null,!1,4228679011)}),a("el-table-column",{attrs:{width:"220",align:"left",label:"订单号",prop:"orders_no"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(t.row.orders_no))]}}],null,!1,3102840766)}),a("el-table-column",{attrs:{width:"180",align:"left",label:"开单时间",prop:"orders_date"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("formatDate")(t.row.orders_date)))]}}],null,!1,3288827973)}),a("el-table-column",{attrs:{width:"160",align:"center",label:"业务类型"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("formatTypeName")(e.compSettleOrdersType,e.$constant.ORDERS_TYPES,"type")))])]}}],null,!1,1933187117)}),a("el-table-column",{attrs:{width:"160",align:"right",label:"订单金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("cent2yuan")(t.row.should_settle_money||t.row.orders_total_money)))]}}],null,!1,2399677281)}),a("el-table-column",{attrs:{width:"160",align:"right",label:"待付金额",prop:"unsettle_money"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("cent2yuan")(t.row.unsettle_money)))]}}],null,!1,803856290)}),a("el-table-column",{attrs:{width:"160",align:"right",label:"本次付款金额",prop:"settle_money"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{staticClass:"tar",attrs:{oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();"},on:{blur:function(a){return e.comfirmSettleMoney(t.row)}},nativeOn:{keyup:function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"enter",13,a.key,"Enter")?null:e.comfirmSettleMoney(t.row)}},model:{value:t.row.settle_money_val,callback:function(a){e.$set(t.row,"settle_money_val",a)},expression:"scope.row.settle_money_val"}})]}}],null,!1,4250043867)}),a("el-table-column",{attrs:{align:"left",label:"备注"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-popover",{attrs:{placement:"top-start",title:"备注信息",width:"300",trigger:"click"}},[a("el-input",{attrs:{type:"textarea",rows:2,placeholder:"请输入备注信息"},model:{value:t.row.remark,callback:function(a){e.$set(t.row,"remark",a)},expression:"scope.row.remark"}}),a("span",{staticClass:"link-hover",attrs:{slot:"reference"},slot:"reference"},[e._v(" "+e._s(t.row.remark||"添加备注")+" ")])],1)]}}],null,!1,3917879094)})],1)],1)]):e._e()],1),a("div",{staticClass:"border-line margin-bottom"}),a("el-row",{attrs:{align:"top"}},[a("el-form-item",{attrs:{label:"实付金额",prop:"payment_money"}},[a("el-input",{staticStyle:{width:"300px"},attrs:{placeholder:"填写实付金额",oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",clearable:""},model:{value:e.formData.payment_money,callback:function(t){e.$set(e.formData,"payment_money",t)},expression:"formData.payment_money"}},[a("template",{slot:"append"},[e._v("元")])],2),[20,11].includes(e.formData.settle_type)?[a("span",{staticClass:"padding-sm margin-left"},[e._v("优惠金额")]),a("el-input",{staticStyle:{width:"200px"},attrs:{placeholder:"填写优惠金额",oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",clearable:""},model:{value:e.formData.discount_money,callback:function(t){e.$set(e.formData,"discount_money",t)},expression:"formData.discount_money"}},[a("template",{slot:"append"},[e._v("元")])],2),a("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"自动将“源单应付合计 - 实付金额”的差额填入优惠金额。",placement:"top"}},[a("span",{staticClass:"padding-sm margin-left-sm el-icon-odometer ft-primary",on:{click:e.handleCalcDiscount}},[e._v("计算优惠")])])]:e._e()],2),a("el-form-item",{attrs:{label:"付款方式",prop:"payment_type"}},[a("el-select",{staticStyle:{width:"300px"},attrs:{placeholder:"请选择付款方式"},model:{value:e.formData.payment_type,callback:function(t){e.$set(e.formData,"payment_type",t)},expression:"formData.payment_type"}},e._l(e.$constant.PAYMENT_TYPES,(function(e,t){return a("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1)],1)],1)],1)]),a("div",{staticClass:"aux-card margin-top"},[a("div",{staticClass:"header"},[a("div",{staticClass:"left"},[a("span",{staticClass:"title"},[e._v("备注信息")])])]),a("div",{staticClass:"padding"},[a("el-input",{attrs:{type:"textarea",placeholder:"请填写备注信息",maxlength:"600","show-word-limit":""},model:{value:e.formData.remark,callback:function(t){e.$set(e.formData,"remark",t)},expression:"formData.remark"}})],1)])]),a("orders-list-dialog",{ref:"ordersListDialog",attrs:{"orders-type":e.compSettleOrdersType,"disabled-list":e.compSettleOrdersIds,"req-params":e.compSettleOrdersReqParam},on:{"selection-submit":e.submitSelectionOrders}})],1)},n=[],s=a("2909"),o=(a("4de4"),a("d3b7"),a("d81d"),a("b0c0"),a("b680"),a("a434"),a("a9e3"),a("13d5"),a("159b"),a("caad"),a("2197")),l=a("2051"),i=a("d262"),d=a("460d"),c={permission:"payment-orders-create",components:{AuxStoreSelect:l["a"],AuxSupplierSelect:i["a"],"orders-list-dialog":d["a"]},data:function(){return{payeeTypes:[{name:"客户",value:1},{name:"供应商",value:2}],formData:{payee_type:2,payee_id:"",payee_name:"",settle_type:20,payment_date:(new Date).getTime(),payment_no:"",orders_list:[],payment_money:"",discount_money:0,payment_type:10,remark:""},rules:{payee_id:[{required:!0,message:"选择收款方",trigger:"blur, change"}],settle_type:[{required:!0,message:"选择收款类型",trigger:"blur"}],payment_date:[{required:!0,message:"请选择收款时间",trigger:"blur"}],payment_money:[{required:!0,message:"请填写实付金额",trigger:"blur"}],payment_type:[{required:!0,message:"选择付款方式",trigger:"blur"}]},ordersList:[]}},computed:{compSettleOrdersType:function(){var e=this,t=this.$constant.SETTLE_ORDERS_TYPES.filter((function(t){return t.value===e.formData.settle_type}));return t.length>0?t[0].refOrdersType:""},compSettleOrdersTypeList:function(){var e=["","store","supplier","member"][this.formData.payee_type];return this.$constant.SETTLE_ORDERS_TYPES.filter((function(t){return"payment"===t.type&&t.target===e}))},compSettleOrdersIds:function(){return this.ordersList.map((function(e){return e.orders_id}))},compSettleOrdersReqParam:function(){var e={settleState:"unsettle",dateSort:"desc"};return 1===this.formData.payee_type&&(e.storeId=this.formData.payee_id),2===this.formData.payee_type&&(e.supplierId=this.formData.payee_id),e}},mounted:function(){var e=this.$route.query||{},t=e.ordersType,a=e.ordersId;t&&a&&this.initSettleDataByOrders(t,a)},methods:{changePayeeType:function(){this.formData.payee_id="",this.formData.settle_type=this.compSettleOrdersTypeList[0].value},changePayeeSelect:function(e){this.formData.payee_name=e.name,this.ordersList=[]},handleAddOrders:function(){this.formData.payee_id?this.$refs.ordersListDialog.open():this.$message.error("请先选择收款方")},submitSelectionOrders:function(e){var t,a=this,r=e.map((function(e){return a.formatOrders(e)}));(t=this.ordersList).push.apply(t,Object(s["a"])(r)),this.autoCalcOrdersAmount()},formatOrders:function(e){var t={orders_id:e._id,orders_no:e.orders_no,orders_date:e.orders_date,orders_record_cnt:e.orders_goods.length,orders_goods_cnt:e.goods_total_count||e.total_goods_count||e.orders_goods_count,total_orders_money:e.orders_total_money,remark:""};return t.should_settle_money=e.should_settle_money||e.orders_total_money,t.unsettle_money=t.should_settle_money-(e.settle_money||0),t.settle_money=t.unsettle_money,t.settle_money_val=(t.unsettle_money/100).toFixed(2),t},changeSettleType:function(){this.ordersList=[]},comfirmSettleMoney:function(e){var t=100*e.settle_money_val;t<=0&&(t=1),t>e.unsettle_money&&(t=e.unsettle_money,this.$message({message:"当前订单收款金额大于待收金额，已自动更正。",type:"info"})),e.settle_money=t,e.settle_money_val=(t/100).toFixed(2),this.autoCalcOrdersAmount()},removeItem:function(e,t){this.ordersList.splice(t,1),this.autoCalcOrdersAmount()},resetForm:function(){this.$refs["elForm"].resetFields(),this.ordersList=[]},submitForm:function(){var e=this;this.$refs["elForm"].validate((function(t){if(t&&e.validateForm()){var a={paymentId:e.paymentId,data:e.getOrdersData()};Object(o["a"])("settle/createPaymentOrders",a,{functionName:"xunda"}).then((function(t){e.$message.success("保存成功"),setTimeout((function(){e.$common.closePage()}),500)}))}}))},getOrdersData:function(){var e=Object.assign({},this.formData,{payment_no:"FKD"+this.$common.format(this.formData.payment_date,"yyyyMMddhhmmss"),payment_date:this.formData.payment_date,orders_list:this.ordersList,payment_money:Number(100*this.formData.payment_money),discount_money:Number(100*this.formData.discount_money),payment_type:this.formData.payment_type,remark:this.formData.remark});return e},validateForm:function(){if(30===this.formData.settle_type)return this.ordersList=[],!0;if(0!==this.ordersList.length){var e=this.getOrdersData(),t=e.orders_list.reduce((function(e,t){return t.settle_money+e}),0),a=t-(e.payment_money+e.discount_money);return a<0?(this.$message.error("收款单金额(含优惠金额)不能大于待收金额"),!1):!(a>0)||(this.$message.error("收款金额(含优惠金额)必须与明细行收款总额一致，请修改后重新提交。"),!1)}this.$common.msg("待结算订单不能为空")},summaryMethod:function(e){var t=e.columns,a=e.data,r=[];return t.forEach((function(e,t){if(0!==t)if(["settle_money","unsettle_money"].includes(e.property)){var n=a.map((function(t){return Number(t[e.property])}));n.every((function(e){return isNaN(e)}))?r[t]="":(r[t]=n.reduce((function(e,t){return e+t}),0),["settle_money","unsettle_money"].includes(e.property)&&(r[t]=(r[t]/100).toFixed(2)))}else r[t]=" ";else r[t]="合计"})),r},handleCalcDiscount:function(){var e=this.ordersList.map((function(e){return e.settle_money})).reduce((function(e,t){return e+t}),0),t=100*this.formData.payment_money;this.formData.discount_money=((e-t)/100).toFixed(2)},autoCalcOrdersAmount:function(){var e=this.ordersList.map((function(e){return e.settle_money})).reduce((function(e,t){return e+t}),0),t=100*(this.formData.discount_money||0),a=e-t;this.formData.payment_money=(a/100).toFixed(2)},initSettleDataByOrders:function(e,t){var a=this;"sales-refund"===e&&Object(o["a"])("orders/getRefundOrders",{ordersId:t},{functionName:"xunda"}).then((function(e){var t=e.data;a.submitSelectionOrders([t]),a.formData.payee_type=1,a.formData.payee_id=t.store_id,a.formData.payee_name=t.store.name,a.formData.settle_type=11})),"purchase"===e&&Object(o["a"])("purchase/getOrders",{ordersId:t},{functionName:"xunda"}).then((function(e){var t=e.data;a.submitSelectionOrders([t]),a.formData.payee_type=2,a.formData.payee_id=t.supplier_id,a.formData.payee_name=t.supplier.name,a.formData.settle_type=20}))}}},u=c,m=(a("1605"),a("2877")),p=Object(m["a"])(u,r,n,!1,null,"32921ea2",null);t["default"]=p.exports},"90ae":function(e,t,a){}}]);