(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-0f7f6fd8"],{"0b09":function(e,t,a){},"460d":function(e,t,a){"use strict";var s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-dialog",{attrs:{title:"源单列表",visible:e.dialogVisible,width:"70%"},on:{"update:visible":function(t){e.dialogVisible=t}}},[a("div",{staticClass:"dflex-s padding-bottom"},[a("el-date-picker",{staticStyle:{width:"300px"},attrs:{type:"daterange","range-separator":" - ","start-placeholder":"开始日期","end-placeholder":"结束日期"},model:{value:e.reqData.dateRange,callback:function(t){e.$set(e.reqData,"dateRange",t)},expression:"reqData.dateRange"}}),a("el-input",{staticClass:"margin-left-sm",staticStyle:{width:"300px"},attrs:{placeholder:"请输入单号搜索",clearable:""},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.fetchDataList(t)}},model:{value:e.reqData.ordersNo,callback:function(t){e.$set(e.reqData,"ordersNo",t)},expression:"reqData.ordersNo"}}),a("el-button",{staticClass:"margin-left-sm",attrs:{type:"primary",icon:"el-icon-search"},on:{click:e.fetchDataList}},[e._v("查 询")])],1),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.dataLoading,expression:"dataLoading"}],staticClass:"aux-table",attrs:{data:e.dataList,border:""},on:{"selection-change":e.handleSelectionChange}},[a("el-table-column",{attrs:{type:"selection",width:"55",align:"center",selectable:e.selectableFunc}}),a("el-table-column",{attrs:{width:"220",align:"left",label:"订单号",fixed:""},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",{staticClass:"link-hover"},[e._v(e._s(t.row.orders_no))])]}}])}),a("el-table-column",{attrs:{width:"180",align:"left",label:"开单时间"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("formatDate")(t.row.orders_date)))])]}}])}),a("el-table-column",{attrs:{width:"120",align:"center",label:"业务类型"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("formatTypeName")(t.row.orders_type,e.$constant.ORDERS_TYPES)))])]}}])}),a("el-table-column",{attrs:{width:"120",align:"right",label:"应"+e.compDeitText+"金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("cent2yuan")(t.row.should_settle_money||t.row.orders_total_money||t.row.total_orders_money)))])]}}])}),a("el-table-column",{attrs:{width:"120",align:"right",label:"已"+e.compDeitText+"金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("cent2yuan")(t.row.settle_money)))])]}}])}),a("el-table-column",{attrs:{width:"120",align:"right",label:"待"+e.compDeitText+"金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",{staticClass:"ft-danger"},[e._v(e._s(e._f("cent2yuan")((t.row.should_settle_money||t.row.orders_total_money)-(t.row.settle_money||0))))])]}}])}),a("el-table-column",{attrs:{align:"left",label:"备注信息","show-overflow-tooltip":""},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(t.row.remark||t.row.orders_remark))]}}])})],1),a("div",{staticClass:"dflex-b padding-top-sm"},[a("div",[a("el-pagination",{attrs:{background:"","page-size":e.pagination.pageSize,total:e.pagination.totalCount,"current-page":e.pagination.pageNo,"page-sizes":[15,20],layout:"total, prev, pager, next"},on:{"current-change":e.changePageNo}})],1),a("div",{staticClass:"padding-bottom-sm"},[a("el-button",{attrs:{type:"primary",disabled:0==e.dataSelection.length},on:{click:e.submit}},[e._v("确认提交")]),a("el-button",{attrs:{type:"default"},on:{click:e.close}},[e._v("取消")])],1)])],1)},r=[],o=a("e177"),n=a.n(o),l=a("2197"),i={name:"OrdersListDialog",props:{ordersType:{type:String,default:"sales"},disabledList:{type:Array,default:()=>[]},reqParams:{type:Object,default:()=>({settleState:"unsettle",dateSort:"desc"})}},data(){return{dialogVisible:!1,filterStates:[{name:"全部",value:""},{name:"待审核",value:0},{name:"待出库",value:1},{name:"待发货",value:2},{name:"待签收",value:3}],dataLoading:!1,dataList:[],dataSelection:[],pagination:{totalCount:1,pageSize:15,pageNo:1},reqData:{dateRange:[],ordersNo:"",state:[]}}},computed:{compDeitText(){return["sales","purchase-refund"].includes(this.ordersType)?"收":["sales-refund","purchase"].includes(this.ordersType)?"付":""}},methods:{async fetchDataList(){const e=Object.assign(this.reqParams,this.reqData,this.pagination),t=this.reqData.dateRange||[];t.length>0&&(e.startDay=n()(t[0]).valueOf(),e.endDay=n()(t[1]).valueOf());const a={sales:"orders/listOrders","sales-refund":"orders/listRefundOrders",purchase:"purchase/listOrders","purchase-refund":"purchase/listRefundOrders"},s=a[this.ordersType];this.dataLoading=!0,Object(l["a"])(s,e,{functionName:"xunda"}).then(e=>{this.dataLoading=!1,this.dataList=(e.data||[]).map(e=>(e.orders_type=this.ordersType,e)),1===this.pagination.pageNo&&(this.pagination.totalCount=e.totalCount)})},changePageNo(e){this.pagination.pageNo=e,this.fetchDataList()},selectableFunc(e,t){return!1===this.disabledList.includes(e._id)},handleSelectionChange(e){this.dataSelection=e},submit(){0!==this.dataSelection.length&&(this.$emit("selection-submit",this.dataSelection),this.close())},open(){this.dialogVisible=!0,this.fetchDataList("refresh")},close(){this.dialogVisible=!1}}},d=i,c=(a("f1ff"),a("2877")),m=Object(c["a"])(d,s,r,!1,null,null,null);t["a"]=m.exports},"5a12":function(e,t,a){},"6d0e":function(e,t,a){"use strict";a("5a12")},"7ce4":function(e,t,a){"use strict";a.r(t);var s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"app-container"},[a("el-form",{ref:"elForm",attrs:{model:e.formData,rules:e.rules,"label-width":"110px"}},[a("div",{staticClass:"aux-card"},[a("div",{staticClass:"header"},[a("div",{staticClass:"left title"},[e._v("付款单")]),a("div",{staticClass:"right"},[a("el-button",{on:{click:e.resetForm}},[e._v("重置")]),a("el-button",{attrs:{type:"primary",icon:"el-icon-save"},on:{click:e.submitForm}},[e._v("保存提交")])],1)]),a("div",{staticClass:"padding"},[a("el-row",{attrs:{align:"top"}},[a("el-form-item",{attrs:{label:"收款方",prop:"payee_id"}},[a("div",{staticClass:"dflex-s"},[a("el-select",{staticStyle:{width:"160px"},attrs:{placeholder:"收款方类型"},on:{change:e.changePayeeType},model:{value:e.formData.payee_type,callback:function(t){e.$set(e.formData,"payee_type",t)},expression:"formData.payee_type"}},e._l(e.payeeTypes,(function(e){return a("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1),1==e.formData.payee_type?[a("AuxStoreSelect",{staticClass:"margin-left-sm",staticStyle:{width:"300px"},on:{change:e.changePayeeSelect},model:{value:e.formData.payee_id,callback:function(t){e.$set(e.formData,"payee_id",t)},expression:"formData.payee_id"}})]:e._e(),2==e.formData.payee_type?[a("AuxSupplierSelect",{staticClass:"margin-left-sm",staticStyle:{width:"300px"},on:{change:e.changePayeeSelect},model:{value:e.formData.payee_id,callback:function(t){e.$set(e.formData,"payee_id",t)},expression:"formData.payee_id"}})]:e._e()],2)]),a("el-form-item",{attrs:{label:"收款时间",prop:"payment_date"}},[a("el-date-picker",{staticStyle:{width:"300px"},attrs:{type:"datetime","value-format":"timestamp",placeholder:"选择收款时间"},model:{value:e.formData.payment_date,callback:function(t){e.$set(e.formData,"payment_date",t)},expression:"formData.payment_date"}})],1),a("el-form-item",{attrs:{label:"收款类型",prop:"settle_type"}},[a("el-select",{staticStyle:{width:"300px"},attrs:{placeholder:"收款类型"},on:{change:e.changeSettleType},model:{value:e.formData.settle_type,callback:function(t){e.$set(e.formData,"settle_type",t)},expression:"formData.settle_type"}},e._l(e.compSettleOrdersTypeList,(function(e){return a("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1)],1),[20,11].includes(e.formData.settle_type)?a("el-form-item",{attrs:{label:"源单信息"}},[a("div",{staticStyle:{"line-height":"20px"}},[a("div",{staticClass:"padding-bottom-sm"},[a("el-button",{attrs:{type:"success",size:"mini",icon:"el-icon-plus"},on:{click:e.handleAddOrders}},[e._v("添加订单")])],1),a("el-table",{staticClass:"aux-table",attrs:{data:e.ordersList,border:"","show-summary":"","summary-method":e.summaryMethod}},[a("el-table-column",{attrs:{width:"60",align:"center",label:"#"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{type:"default",size:"mini",icon:"el-icon-minus",circle:""},on:{click:function(a){return e.removeItem(t.row,t.$index)}}})]}}],null,!1,4228679011)}),a("el-table-column",{attrs:{width:"220",align:"left",label:"单据编号",prop:"orders_no"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(t.row.orders_no))]}}],null,!1,3102840766)}),a("el-table-column",{attrs:{width:"180",align:"left",label:"单据日期",prop:"orders_date"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("formatDate")(t.row.orders_date)))]}}],null,!1,3288827973)}),a("el-table-column",{attrs:{width:"120",align:"center",label:"单据类型"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("span",[e._v(e._s(e._f("formatTypeName")(t.row.orders_type,e.$constant.ORDERS_TYPES)))])]}}],null,!1,903515592)}),a("el-table-column",{attrs:{width:"120",align:"right",label:"单据金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("cent2yuan")(t.row.orders_total_money)))]}}],null,!1,3750714182)}),a("el-table-column",{attrs:{width:"120",align:"right",label:"已结金额"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("cent2yuan")(t.row.settled_money+(t.row.settled_chargeoff_money||0))))]}}],null,!1,1504660792)}),a("el-table-column",{attrs:{width:"120",align:"right",label:"未结金额",prop:"unsettle_money"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(e._f("cent2yuan")(t.row.unsettle_money)))]}}],null,!1,803856290)}),a("el-table-column",{attrs:{width:"140",align:"right",label:"本次付款金额",prop:"settle_money"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{staticClass:"tar",attrs:{oninput:"value=value.match(/^\\d+(?:\\.\\d{0,3})?/)",onfocus:"this.select();"},on:{blur:function(a){return e.comfirmSettleMoney(t.row)}},nativeOn:{keyup:function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"enter",13,a.key,"Enter")?null:e.comfirmSettleMoney(t.row)}},model:{value:t.row.settle_money_val,callback:function(a){e.$set(t.row,"settle_money_val",a)},expression:"scope.row.settle_money_val"}})]}}],null,!1,1621619834)}),a("el-table-column",{attrs:{align:"left",label:"备注"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-popover",{attrs:{placement:"top-start",title:"备注信息",width:"300",trigger:"click"}},[a("el-input",{attrs:{type:"textarea",rows:2,placeholder:"请输入备注信息"},model:{value:t.row.remark,callback:function(a){e.$set(t.row,"remark",a)},expression:"scope.row.remark"}}),a("span",{staticClass:"link-hover",attrs:{slot:"reference"},slot:"reference"},[e._v(" "+e._s(t.row.remark||"添加备注")+" ")])],1)]}}],null,!1,3917879094)})],1)],1)]):e._e()],1),a("div",{staticClass:"border-line margin-bottom"}),a("el-row",{attrs:{align:"top"}},[a("el-form-item",{attrs:{label:"实付金额",prop:"payment_money"}},[a("el-input",{staticStyle:{width:"300px"},attrs:{placeholder:"填写实付金额",oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",clearable:""},model:{value:e.formData.payment_money,callback:function(t){e.$set(e.formData,"payment_money",t)},expression:"formData.payment_money"}},[a("template",{slot:"append"},[e._v("元")])],2),[20,11].includes(e.formData.settle_type)?[a("span",{staticClass:"padding-sm margin-left"},[e._v("优惠金额")]),a("el-input",{staticStyle:{width:"200px"},attrs:{placeholder:"填写优惠金额",oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",clearable:""},model:{value:e.formData.discount_money,callback:function(t){e.$set(e.formData,"discount_money",t)},expression:"formData.discount_money"}},[a("template",{slot:"append"},[e._v("元")])],2),a("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"自动将“源单应付合计 - 实付金额”的差额填入优惠金额。",placement:"top"}},[a("span",{staticClass:"padding-sm margin-left-sm el-icon-odometer ft-primary",on:{click:e.handleCalcDiscount}},[e._v("计算优惠")])])]:e._e()],2),a("el-form-item",{attrs:{label:"付款方式",prop:"payment_type"}},[a("el-select",{staticStyle:{width:"300px"},attrs:{placeholder:"请选择付款方式"},model:{value:e.formData.payment_type,callback:function(t){e.$set(e.formData,"payment_type",t)},expression:"formData.payment_type"}},e._l(e.$constant.PAYMENT_TYPES,(function(e,t){return a("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1)],1)],1)],1)]),a("div",{staticClass:"aux-card margin-top"},[a("div",{staticClass:"header"},[a("div",{staticClass:"left"},[a("span",{staticClass:"title"},[e._v("备注信息")])])]),a("div",{staticClass:"padding"},[a("el-input",{attrs:{type:"textarea",placeholder:"请填写备注信息",maxlength:"600","show-word-limit":""},model:{value:e.formData.remark,callback:function(t){e.$set(e.formData,"remark",t)},expression:"formData.remark"}})],1)])]),a("orders-list-dialog",{ref:"ordersListDialog",attrs:{"orders-type":e.compSettleOrdersType,"disabled-list":e.compSettleOrdersIds,"req-params":e.compSettleOrdersReqParam},on:{"selection-submit":e.submitSelectionOrders}})],1)},r=[],o=(a("13d5"),a("2197")),n=a("2051"),l=a("d262"),i=a("460d"),d={permission:"payment-orders-create",components:{AuxStoreSelect:n["a"],AuxSupplierSelect:l["a"],"orders-list-dialog":i["a"]},data(){return{payeeTypes:[{name:"客户",value:1},{name:"供应商",value:2}],formData:{payee_type:2,payee_id:"",payee_name:"",settle_type:20,payment_date:(new Date).getTime(),payment_no:"",orders_list:[],payment_money:"",discount_money:0,payment_type:10,remark:""},rules:{payee_id:[{required:!0,message:"选择收款方",trigger:"blur, change"}],settle_type:[{required:!0,message:"选择收款类型",trigger:"blur"}],payment_date:[{required:!0,message:"请选择收款时间",trigger:"blur"}],payment_money:[{required:!0,message:"请填写实付金额",trigger:"blur"}],payment_type:[{required:!0,message:"选择付款方式",trigger:"blur"}]},ordersList:[]}},computed:{compSettleOrdersType(){const e=this.$constant.SETTLE_ORDERS_TYPES.filter(e=>e.value===this.formData.settle_type);return e.length>0?e[0].refOrdersType:""},compSettleOrdersTypeList(){const e=["","store","supplier","member"][this.formData.payee_type];return this.$constant.SETTLE_ORDERS_TYPES.filter(t=>"payment"===t.type&&t.target===e)},compSettleOrdersIds(){return this.ordersList.map(e=>e.orders_id)},compSettleOrdersReqParam(){const e={settleState:"unsettle",dateSort:"desc"};return 1===this.formData.payee_type&&(e.storeId=this.formData.payee_id),2===this.formData.payee_type&&(e.supplierId=this.formData.payee_id),e}},mounted(){const{ordersType:e,ordersId:t}=this.$route.query||{};e&&t&&this.initSettleDataByOrders(e,t)},methods:{changePayeeType(){this.formData.payee_id="",this.formData.settle_type=this.compSettleOrdersTypeList[0].value},changePayeeSelect(e){this.formData.payee_name=e.name,this.ordersList=[]},handleAddOrders(){this.formData.payee_id?this.$refs.ordersListDialog.open():this.$message.error("请先选择收款方")},submitSelectionOrders(e){const t=e.map(e=>this.formatOrders(e));this.ordersList.push(...t),this.autoCalcOrdersAmount()},formatOrders(e){const t={orders_id:e._id,orders_no:e.orders_no,orders_date:e.orders_date,orders_type:e.orders_type,orders_goods_cnt:e.goods_total_count||e.total_goods_count,orders_total_money:e.orders_total_money};return t.settled_state=e.settle_state,t.settled_money=e.settled_money||0,t.settled_discount_money=e.settle_discount_money||0,t.settled_chargeoff_money=e.settle_chargeoff_money||0,t.unsettle_money=e.unsettle_money,t.settle_money=e.unsettle_money,t.settle_money_val=this.$common.cent2yuan(t.settle_money),t},changeSettleType(){this.ordersList=[]},comfirmSettleMoney(e){let t=100*e.settle_money_val;t<=0&&(t=1),t>e.unsettle_money&&(t=e.unsettle_money,this.$message({message:"当前订单收款金额大于待收金额，已自动更正。",type:"info"})),e.settle_money=t,e.settle_money_val=(t/100).toFixed(2),this.autoCalcOrdersAmount()},removeItem(e,t){this.ordersList.splice(t,1),this.autoCalcOrdersAmount()},resetForm(){this.$refs["elForm"].resetFields(),this.ordersList=[]},submitForm(){this.$refs["elForm"].validate(e=>{if(!e||!this.validateForm())return;const t={paymentId:this.paymentId,data:this.getOrdersData()};Object(o["a"])("settle/createPaymentOrders",t,{functionName:"xunda"}).then(e=>{this.$message.success("保存成功"),setTimeout(()=>{this.$common.toPage("/accounting/payment/orders-detail/"+e.data)},300)})})},getOrdersData(){const e=Object.assign({},this.formData,{payment_no:"FKD"+this.$common.format(this.formData.payment_date,"yyyyMMddhhmmss"),payment_date:this.formData.payment_date,orders_list:this.ordersList,payment_money:Number(100*this.formData.payment_money),discount_money:Number(100*this.formData.discount_money),payment_type:this.formData.payment_type,remark:this.formData.remark});return e},validateForm(){if(30===this.formData.settle_type)return this.ordersList=[],!0;if(0===this.ordersList.length)return void this.$common.msg("待结算订单不能为空");const e=this.getOrdersData(),t=e.orders_list.reduce((e,t)=>t.settle_money+e,0),a=t-(e.payment_money+e.discount_money);return a<0?(this.$message.error("收款单金额(含优惠金额)不能大于待收金额"),!1):!(a>0)||(this.$message.error("收款金额(含优惠金额)必须与明细行收款总额一致，请修改后重新提交。"),!1)},summaryMethod({columns:e,data:t}){const a=[];return e.forEach((e,s)=>{if(0===s)return void(a[s]="合计");if(!["settle_money","unsettle_money"].includes(e.property))return void(a[s]=" ");const r=t.map(t=>Number(t[e.property]));r.every(e=>isNaN(e))?a[s]="":(a[s]=r.reduce((e,t)=>e+t,0),["settle_money","unsettle_money"].includes(e.property)&&(a[s]=(a[s]/100).toFixed(2)))}),a},handleCalcDiscount(){const e=this.ordersList.reduce((e,t)=>e+t.settle_money,0),t=this.$common.yuan2cent(this.formData.receipt_money);this.formData.discount_money=this.$common.cent2yuan(Number(e)-Number(t))},autoCalcOrdersAmount(){const e=this.ordersList.reduce((e,t)=>e+t.settle_money,0),t=Number(this.$common.yuan2cent(this.formData.discount_money||0)),a=e-t;this.formData.payment_money=this.$common.cent2yuan(a)},initSettleDataByOrders(e,t){"sales-refund"===e&&Object(o["a"])("orders/getRefundOrders",{ordersId:t},{functionName:"xunda"}).then(e=>{const t=e.data;t.forEach(e=>e.orders_type="sales-refund"),this.submitSelectionOrders([t]),this.formData.payee_type=1,this.formData.payee_id=t.store_id,this.formData.payee_name=t.store.name,this.formData.settle_type=11}),"purchase"===e&&Object(o["a"])("purchase/getOrders",{ordersId:t},{functionName:"xunda"}).then(e=>{const t=e.data;t.forEach(e=>e.orders_type="purchase"),this.submitSelectionOrders([t]),this.formData.payee_type=2,this.formData.payee_id=t.supplier_id,this.formData.payee_name=t.supplier.name,this.formData.settle_type=20})}}},c=d,m=(a("6d0e"),a("2877")),u=Object(m["a"])(c,s,r,!1,null,"4feeaeaf",null);t["default"]=u.exports},f1ff:function(e,t,a){"use strict";a("0b09")}}]);