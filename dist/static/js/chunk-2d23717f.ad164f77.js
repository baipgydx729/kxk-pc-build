(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d23717f"],{fa3a:function(e,o,t){"use strict";t.r(o);var s=function(){var e=this,o=e.$createElement,t=e._self._c||o;return t("div",{staticClass:"app-container"},[t("div",{staticClass:"aux-card"},[t("div",{staticClass:"header"},[t("div",{staticClass:"left title"},[e._v("销售开单")]),t("div",{staticClass:"right"},[t("el-button",{attrs:{type:"default",icon:"el-icon-tickets"},on:{click:function(o){return e.$common.closePage()}}},[e._v("取消")]),t("el-button",{attrs:{loading:e.submitLoading,type:"primary",icon:"el-icon-document-checked"},on:{click:e.handleSave}},[e._v("保存 (Ctrl+S)")])],1)]),t("div",{staticClass:"margin-top-sm"},[t("el-form",{ref:"baseForm",attrs:{"label-width":"90px","label-align":"left",inline:!0}},[t("div",{staticClass:"dflex-s"},[t("el-form-item",{attrs:{label:"选择客户"}},[t("AuxStoreSelect",{staticStyle:{width:"300px"},on:{change:e.changeStoreSelect},model:{value:e.baseForm.receiver_id,callback:function(o){e.$set(e.baseForm,"receiver_id",o)},expression:"baseForm.receiver_id"}})],1),t("el-form-item",{attrs:{label:"开单日期"}},[t("el-date-picker",{staticStyle:{width:"300px"},attrs:{type:"datetime","value-format":"timestamp"},model:{value:e.baseForm.orders_date,callback:function(o){e.$set(e.baseForm,"orders_date",o)},expression:"baseForm.orders_date"}})],1),t("el-form-item",{attrs:{label:"业务员"}},[t("AuxMemberSelect",{model:{value:e.baseForm.sale_manid,callback:function(o){e.$set(e.baseForm,"sale_manid",o)},expression:"baseForm.sale_manid"}})],1)],1)])],1),t("OrdersGoodsTable",{ref:"goodsTable",on:{change:e.changeOrdersGoodsCompleted}})],1),t("el-card",{staticClass:"aux-card margin-top",attrs:{shadow:"none","body-style":{padding:"12px"}}},[t("el-form",{ref:"baseForm",attrs:{"label-width":"80px","label-align":"left",inline:!0}},[t("el-form-item",{attrs:{label:"整单优惠"}},[t("el-input",{attrs:{oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",placeholder:"整单优惠"},on:{blur:e.changeOrdersDiscountMoney},model:{value:e.baseForm.orders_discount_money,callback:function(o){e.$set(e.baseForm,"orders_discount_money",o)},expression:"baseForm.orders_discount_money"}},[t("template",{slot:"append"},[e._v("元")])],2)],1),t("el-form-item",{attrs:{label:"其他费用"}},[t("el-input",{attrs:{oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",placeholder:"其他费用"},on:{change:e.changeOrdersCompleted},model:{value:e.baseForm.orders_extend_fee,callback:function(o){e.$set(e.baseForm,"orders_extend_fee",o)},expression:"baseForm.orders_extend_fee"}},[t("template",{slot:"append"},[e._v("元")])],2)],1),t("el-form-item",{attrs:{label:"订单金额"}},[t("el-input",{attrs:{disabled:"",placeholder:"金额"},model:{value:e.baseForm.orders_total_money,callback:function(o){e.$set(e.baseForm,"orders_total_money",o)},expression:"baseForm.orders_total_money"}},[t("template",{slot:"append"},[e._v("元")])],2)],1)],1),t("div",{staticClass:"dflex-e padding-tb border-top"},[t("span",{staticClass:"padding-left"},[e._v("整单优惠："+e._s(e.baseForm.orders_discount_money))]),t("span",{staticClass:"padding-left"},[e._v("其他费用："+e._s(e.baseForm.orders_extend_fee))]),t("span",{staticClass:"padding-left"},[e._v(" 订单总金额： "),t("span",{staticClass:"fs-lg"},[e._v(e._s(e.baseForm.orders_total_money))])])])],1),t("el-card",{staticClass:"aux-card margin-top",attrs:{shadow:"none","body-style":{padding:"12px"}}},[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("订单备注")])]),t("el-input",{attrs:{type:"textarea",placeholder:"请输入内容",maxlength:"600","show-word-limit":""},model:{value:e.baseForm.orders_remark,callback:function(o){e.$set(e.baseForm,"orders_remark",o)},expression:"baseForm.orders_remark"}})],1),t("el-card",{staticClass:"aux-card margin-top",attrs:{shadow:"none","body-style":{padding:"12px"}}},[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",[e._v("内部备注")])]),t("el-input",{attrs:{type:"textarea",placeholder:"请输入内容",maxlength:"600","show-word-limit":""},model:{value:e.baseForm.create_remark,callback:function(o){e.$set(e.baseForm,"create_remark",o)},expression:"baseForm.create_remark"}})],1)],1)},r=[],a=t("b7ac"),d=t("2051"),n=t("b866"),i=t("2197"),m={name:"SalesOrdersCreate",components:{OrdersGoodsTable:a["a"],AuxStoreSelect:d["a"],AuxMemberSelect:n["a"]},data(){return{permission:"sales-orders-create",ordersId:"",prepareId:"",baseForm:{orders_date:(new Date).getTime(),orders_no:"",receiver_id:"",receiver:{_id:"",name:"",contact:"",telephone:"",sale_grade:0},orders_goods:[],sale_manid:"",orders_remark:"",create_remark:"",create_uname:"",goods_total_count:0,goods_original_money:0,goods_discount_money:0,goods_total_money:0,orders_discount_money:0,orders_extend_fee:0,orders_total_money:0,ordersIdentifys:[]},submitLoading:!1}},computed:{},mounted(){const{type:e,id:o,storeId:t}=this.$route.query||{};"edit"===e&&o&&(this.ordersId=o,this.fetchDetail(o)),"copyAdd"===e&&(this.ordersId="",this.fetchDetail(o)),"fromPrepare"===e&&(this.prepareId=o,this.fetchPrepareOrders(o)),t&&(this.baseForm.receiver_id=t)},onUnload(){this.setOrdersIdentifys([])},methods:{fetchDetail(e){Object(i["a"])("orders/getOrders",{ordersId:e||this.ordersId},{functionName:"xunda"}).then(e=>{this.initOrdersData(e.data)})},fetchPrepareOrders(e){Object(i["a"])("prepare/getOrders",{ordersId:e},{functionName:"xunda"}).then(e=>{const o=e.data,t=o.orders_goods.map(e=>(e.sales_goods_cnt&&(e.goods_cnt=Math.max(0,e.goods_cnt-e.sales_goods_cnt)),e)).filter(e=>e.goods_cnt>0);o.orders_goods=t,this.initOrdersData(o)})},initOrdersData(e){const o={};o.receiver_id=e.receiver_id||e.store_id,o.receiver=e.receiver||e.store,o.orders_date=e.orders_date,o.orders_no=e.orders_no,o.orders_remark=e.orders_remark,o.create_remark=e.create_remark,o.create_uname=e.create_uname,o.sale_manid=e.sale_manid||"",o.prepare_id=e.prepare_id,o.orders_total_money=this.$common.cent2yuan(e.orders_total_money),o.orders_extend_fee=this.$common.cent2yuan(e.orders_extend_fee||0),o.orders_discount_money=this.$common.cent2yuan(e.orders_discount_money||0),o.goods_total_count=e.goods_total_count||e.orders_goods_count,o.goods_original_money=e.goods_original_money>0?this.$common.cent2yuan(e.goods_original_money):o.ordersTotalMoney,o.goods_discount_money=e.goods_discount_money>0?this.$common.cent2yuan(e.goods_discount_money):0,o.goods_total_money=e.goods_total_money>0?this.$common.cent2yuan(e.goods_total_money):o.goodsOriginalMoney,o.orders_goods=e.orders_goods.map(e=>{const o=Object.assign({},e);return o.goods_ori_price=this.$common.cent2yuan(e.goods_ori_price||o.goods_price),o.total_ori_money=this.$common.cent2yuan(e.total_ori_money||o.total_money),o.total_money=this.$common.cent2yuan(e.total_money),o.goods_price=this.$common.cent2yuan(e.goods_price),o}),this.$refs.goodsTable.initData(o.orders_goods),this.setOrdersIdentifys(o.orders_identifys),this.baseForm=o},changeStoreSelect(e){this.baseForm.receiver_id=e._id,this.baseForm.receiver={_id:e._id,name:e.name,contact:e.contact,telephone:e.telephone,address:e.address,sale_grade:e.sale_grade}},changeOrdersDiscountMoney(){this.baseForm.orders_discount_money=Math.min(this.baseForm.orders_discount_money,this.baseForm.goods_total_money),this.changeOrdersGoodsCompleted()},changeOrdersGoodsCompleted(){const{goodsTotalCount:e=0,goodsOriginalMoney:o=0,goodsDiscountMoney:t=0,goodsTotalMoney:s=0}=this.$refs.goodsTable.getSummaryData();this.baseForm.goods_total_count=e,this.baseForm.goods_original_money=o,this.baseForm.goods_discount_money=t,this.baseForm.goods_total_money=s,this.changeOrdersCompleted()},changeOrdersCompleted(){this.baseForm.orders_discount_money=(Number(this.baseForm.orders_discount_money)||0).toFixed(2),this.baseForm.orders_extend_fee=(Number(this.baseForm.orders_extend_fee)||0).toFixed(2),this.baseForm.orders_total_money=(Number(this.baseForm.goods_total_money)+Number(this.baseForm.orders_extend_fee)-Number(this.baseForm.orders_discount_money)).toFixed(2)},validateForm(){if(!this.baseForm.receiver_id)return void this.$message.error("请选择客户");const e=this.$refs.goodsTable.getListData();if(0!==e.length)return!0;this.$message.error("商品清单为空")},handleSave(){this.validateForm()&&this.submitForm(!0)},async submitForm(e=!0){const o={ordersId:this.ordersId,data:this.getOrdersData(),sureOk:e};this.submitLoading=!0,Object(i["a"])("orders/saveOrders",o,{functionName:"xunda"}).then(e=>{this.submitLoading=!1,this.$message.success("保存成功"),this.clearOrdersIdentify(),setTimeout(()=>this.$router.push({name:"SalesOrdersDetail",params:{ordersId:e.data,t:Date.now()}}),300),this.$common.closePage()},e=>{this.submitLoading=!1})},getOrdersData(){const e=Object.assign({},this.baseForm,{orders_type:1,orders_date:this.baseForm.orders_date,receiver_id:this.baseForm.receiver_id,receiver:this.baseForm.receiver,orders_remark:this.baseForm.orders_remark,create_remark:this.baseForm.create_remark,orders_identifys:this.baseForm.ordersIdentifys,orders_goods:this.getOrdersGoods(),goods_total_count:this.baseForm.goods_total_count,goods_original_money:this.$common.yuan2cent(this.baseForm.goods_original_money),goods_discount_money:this.$common.yuan2cent(this.baseForm.goods_discount_money),goods_total_money:this.$common.yuan2cent(this.baseForm.goods_total_money),orders_discount_money:this.$common.yuan2cent(this.baseForm.orders_discount_money),orders_extend_fee:this.$common.yuan2cent(this.baseForm.orders_extend_fee),orders_total_money:this.$common.yuan2cent(this.baseForm.orders_total_money)});return this.ordersId||(e.orders_no="XSD"+this.$common.format(new Date,"yyyyMMddhhmmssS")),this.prepareId&&(e.prepare_id=this.prepareId),e},getOrdersGoods(){const e=this,o=this.$refs.goodsTable.getListData();return o.map(o=>{const t=Object.assign({},o,{goods_ori_price:e.$common.yuan2cent(o.goods_ori_price),total_ori_money:e.$common.yuan2cent(o.total_ori_money),goods_price:e.$common.yuan2cent(o.goods_price),total_money:e.$common.yuan2cent(o.total_money)});return t})},handleAddIdentify(){},setOrdersIdentifys(e){this.ordersIdentifys=e||[]},clearOrdersIdentify(){}}},c=m,_=t("2877"),l=Object(_["a"])(c,s,r,!1,null,null,null);o["default"]=l.exports}}]);