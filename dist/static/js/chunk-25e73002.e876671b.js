(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-25e73002"],{"168a":function(e,t,a){"use strict";var o=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("el-select",e._b({staticClass:"w-full",attrs:{filterable:"",placeholder:e.$attrs.placeholder||"输入订单号查询",clearable:e.$attrs.clearable||!0,remote:"","remote-method":e.remoteMethod,loading:e.loading},on:{change:e.change,focus:e.initLoad,clear:e.clear},model:{value:e.modelValue,callback:function(t){e.modelValue=t},expression:"modelValue"}},"el-select",e.$attrs,!1),e._l(e.dataList,(function(t){return a("el-option",{key:t.value,attrs:{label:t.name,value:t.value}},[a("div",{staticClass:"dflex-b"},[a("div",[e._v(" "+e._s(t.orders_no)+" ")])])])})),1)],1)},r=[],s=a("2197"),d={name:"AuxSelectOrders",props:{value:{type:[String,Array],default:()=>""},ordersTarget:{type:String,default:"",required:!0},ordersType:{type:String,default:"sales",required:!0,validator:e=>-1!==["sales","purchase"].indexOf(e)},reqParams:{type:Object,default:()=>({})}},data(){return{loading:!1,dataList:[],modelValue:""}},watch:{value:{handler(e,t){this.modelValue=e},immediate:!0},ordersTarget:{handler(e,t){this.dataList=[]},immediate:!0}},methods:{initLoad(){this.dataList.length>0||this.fetchData()},fetchData(e=""){this.loading=!0;const t=Object.assign({ordersNo:e},this.reqParams,{pageSize:10});"sales"===this.ordersType?t.storeId=this.ordersTarget:"sales"===this.ordersType&&(t.supplierId=this.ordersTarget);const a={sales:"orders/listOrders",purchase:"purchase/listOrders"},o=a[this.ordersType];Object(s["a"])(o,t,{functionName:"xunda"}).then(e=>{this.loading=!1,this.dataList=(e.data||[]).map(e=>(e.name=e.orders_no||"",e.value=e._id,e))})},remoteMethod(e){e&&""!==e?(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.fetchData(e)},200)):this.dataList=[]},change(){this.$nextTick(()=>{this.$emit("input",this.modelValue);const e=this.dataList.filter(e=>e.value===this.modelValue);e.length>0&&this.$emit("change",e[0])})},clear(){this.$emit("clear")}}},i=d,n=a("2877"),l=Object(n["a"])(i,o,r,!1,null,null,null);t["a"]=l.exports},"2a80":function(e,t,a){"use strict";a.r(t);var o=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"app-container"},[a("el-form",{ref:"formData",attrs:{model:e.formData,rules:e.rules,"label-width":"90px","label-align":"left",inline:!0}},[a("div",{staticClass:"aux-card"},[a("div",{staticClass:"header"},[a("div",{staticClass:"left title"},[e._v("销售退单")]),a("div",{staticClass:"right"},[a("el-button",{attrs:{type:"default",icon:"el-icon-tickets"},on:{click:function(t){return e.$common.closePage()}}},[e._v("取消")]),a("el-button",{attrs:{type:"primary",icon:"el-icon-document-checked"},on:{click:e.handleSave}},[e._v("保存 (Ctrl+S)")])],1)]),a("div",{staticClass:"margin-top-sm"},[a("div",{staticClass:"dflex-s"},[a("el-form-item",{attrs:{label:"选择客户",prop:"store_id"}},[a("AuxStoreSelect",{staticStyle:{width:"260px"},on:{change:e.changeStoreSelect},model:{value:e.formData.store_id,callback:function(t){e.$set(e.formData,"store_id",t)},expression:"formData.store_id"}})],1),a("el-form-item",{attrs:{label:"原销售单",prop:"rel_orders_id"}},[a("AuxOrdersSelect",{staticStyle:{width:"260px"},attrs:{"orders-type":"sales","orders-target":e.formData.store_id,"req-params":{settleState:"unsettle",dateSort:"desc"},disabled:!e.formData.store_id},on:{change:e.changeOrdersSelect,clear:e.clearOrdersSelect},model:{value:e.formData.rel_orders_id,callback:function(t){e.$set(e.formData,"rel_orders_id",t)},expression:"formData.rel_orders_id"}})],1),a("el-form-item",{attrs:{label:"开单日期",prop:"orders_date"}},[a("el-date-picker",{staticStyle:{width:"260px"},attrs:{type:"datetime","value-format":"timestamp"},model:{value:e.formData.orders_date,callback:function(t){e.$set(e.formData,"orders_date",t)},expression:"formData.orders_date"}})],1),a("el-form-item",{attrs:{label:"业务员"}},[a("AuxMemberSelect",{model:{value:e.formData.sale_manid,callback:function(t){e.$set(e.formData,"sale_manid",t)},expression:"formData.sale_manid"}})],1)],1)]),a("OrdersGoodsTable",{ref:"goodsTable",attrs:{"disabled-custom-add":!!e.formData.rel_orders_id},on:{change:e.changeGoodsCompleted}})],1),a("div",{staticClass:"aux-card margin-top-sm"},[a("div",{staticClass:"padding-top"},[a("el-form-item",{attrs:{label:"其他费用"}},[a("el-input",{attrs:{oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",placeholder:"其他费用"},on:{change:e.changeOrdersCompleted},model:{value:e.formData.orders_extend_fee,callback:function(t){e.$set(e.formData,"orders_extend_fee",t)},expression:"formData.orders_extend_fee"}},[a("template",{slot:"append"},[e._v("元")])],2)],1),a("el-form-item",{attrs:{label:"退单金额"}},[a("el-input",{attrs:{disabled:"",placeholder:"金额"},model:{value:e.formData.orders_total_money,callback:function(t){e.$set(e.formData,"orders_total_money",t)},expression:"formData.orders_total_money"}},[a("template",{slot:"append"},[e._v("元")])],2)],1)],1),a("div",{staticClass:"dflex-e padding border-top"},[a("span",{staticClass:"padding-left"},[e._v("其他费用："+e._s(e.formData.orders_extend_fee))]),a("span",{staticClass:"padding-left"},[e._v("退单金额："+e._s(e.formData.orders_total_money))])])]),a("div",{staticClass:"aux-card margin-top"},[a("div",{staticClass:"header"},[a("span",{staticClass:"left title"},[e._v("其他信息")])]),a("div",{staticClass:"padding-top"},[a("el-form-item",{attrs:{label:"退单原因"}},[a("el-select",{attrs:{placeholder:"请选择退单原因",clearable:""},model:{value:e.formData.reason_type,callback:function(t){e.$set(e.formData,"reason_type",t)},expression:"formData.reason_type"}},e._l(e.$constant.REFUND_REASON_TYPES,(function(e){return a("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1)],1),99==e.formData.reason_type?a("div",[a("el-form-item",{attrs:{label:"原因说明"}},[a("el-input",{staticStyle:{width:"40vw"},attrs:{type:"textarea",placeholder:"请填写退单说明",maxlength:"300","show-word-limit":""},model:{value:e.formData.reason_content,callback:function(t){e.$set(e.formData,"reason_content",t)},expression:"formData.reason_content"}})],1)],1):e._e(),a("el-form-item",{attrs:{label:"备注信息",inline:!1}},[a("el-input",{staticStyle:{width:"80vw"},attrs:{type:"textarea",placeholder:"请填写备注信息",maxlength:"600","show-word-limit":""},model:{value:e.formData.remark,callback:function(t){e.$set(e.formData,"remark",t)},expression:"formData.remark"}})],1)],1)])])],1)},r=[],s=a("b7ac"),d=a("2051"),i=a("168a"),n=a("b866"),l=a("2197"),m={name:"SalesRefundCreate",components:{OrdersGoodsTable:s["a"],AuxStoreSelect:d["a"],AuxOrdersSelect:i["a"],AuxMemberSelect:n["a"]},data(){return{permission:"sales-refund-create",ordersId:"",formData:{orders_date:(new Date).getTime(),orders_no:"",store_id:"",store:{_id:"",name:""},orders_goods:[],sale_manid:"",remark:"",create_uname:"",goods_total_count:0,goods_total_money:0,orders_extend_fee:0,orders_total_money:0,rel_orders_id:"",rel_orders:{},reason_type:10,reason_content:""},rules:{store_id:[{required:!0,message:"请选择客户信息",trigger:"change, blur"}],orders_date:[{required:!0,message:"请填写开单日期",trigger:"change, blur"}]}}},computed:{},mounted(){const{storeId:e,id:t}=this.$route.query||{};e&&(this.formData.store_id=e),t&&(this.ordersId=t,this.fetchDetail())},methods:{fetchDetail(){Object(l["a"])("orders/getOrders",{ordersId:this.ordersId},{functionName:"xunda"}).then(e=>{this.initOrdersData(e.data)})},initOrdersData(e){const t={};t.store_id=e.store_id,t.store=e.store,t.orders_date=e.orders_date,t.orders_no=e.orders_no,t.remark=e.remark,t.create_uname=e.create_uname,t.goods_total_count=e.goods_total_count||e.orders_goods_count||0,t.goods_total_money=this.$common.cent2yuan(e.goods_total_money||t.orders_total_money),t.orders_total_money=this.$common.cent2yuan(e.orders_total_money||0),t.orders_extend_fee=this.$common.cent2yuan(e.orders_extend_fee||0),t.orders_goods=e.orders_goods.map(e=>{const t=Object.assign({},e);return t.goods_ori_price=this.$common.cent2yuan(e.goods_ori_price||t.goods_price),t.total_ori_money=this.$common.cent2yuan(e.total_ori_money||t.total_money),t.total_money=this.$common.cent2yuan(e.total_money),t.goods_price=this.$common.cent2yuan(e.goods_price),t}),this.$refs.goodsTable.initData(t.orders_goods),this.formData=t},changeStoreSelect(e){this.formData.store_id=e._id,this.formData.store={_id:e._id,name:e.name,contact:e.contact,telephone:e.telephone,address:e.address},this.formData.rel_orders_id="",this.$refs.goodsTable.initData([]),this.$refs.goodsTable.addEmpty(),this.changeOrdersCompleted()},changeOrdersSelect(e){this.formData.rel_orders_id=e._id,this.formData.rel_orders={orders_no:e.orders_no,orders_id:e._id};const t=e.orders_goods.map(e=>{const t=Object.assign({},e);return t.goods_ori_price=this.$common.cent2yuan(e.goods_ori_price||t.goods_price),t.total_ori_money=this.$common.cent2yuan(e.total_ori_money||t.total_money),t.total_money=this.$common.cent2yuan(e.total_money),t.goods_price=this.$common.cent2yuan(e.goods_price),t});this.$refs.goodsTable.initData(t),this.changeOrdersCompleted()},clearOrdersSelect(){this.$refs.goodsTable.initData([]),this.changeOrdersCompleted()},changeGoodsCompleted(){const{goodsTotalCount:e=0,goodsTotalMoney:t=0}=this.$refs.goodsTable.getSummaryData();this.formData.goods_total_count=e,this.formData.goods_total_money=t,this.changeOrdersCompleted()},changeOrdersCompleted(){this.formData.orders_discount_money=(Number(this.formData.orders_discount_money)||0).toFixed(2),this.formData.orders_extend_fee=(Number(this.formData.orders_extend_fee)||0).toFixed(2),this.formData.orders_total_money=(Number(this.formData.goods_total_money)+Number(this.formData.orders_extend_fee)).toFixed(2)},validateForm(){const e=this.$refs.goodsTable.getListData();if(0!==e.length)return!0;this.$message.error("商品清单为空")},handleSave(){this.$refs["formData"].validate(e=>{e&&this.validateForm()&&this.submitForm()})},async submitForm(){const e={ordersId:this.ordersId,data:this.getOrdersData()};Object(l["a"])("orders/createRefundOrders",e,{functionName:"xunda"}).then(e=>{this.$message("保存成功"),setTimeout(()=>this.$router.push({name:"SalesRefundDetail",params:{ordersId:e.data}}),300),this.$common.closePage()},e=>{this.$message.error(e.message)})},getOrdersData(){const e=Object.assign({},this.formData,{orders_goods:this.getOrdersGoods(),goods_total_count:this.formData.goods_total_count,goods_total_money:this.$common.yuan2cent(this.formData.goods_total_money),orders_extend_fee:this.$common.yuan2cent(this.formData.orders_extend_fee||0),orders_total_money:this.$common.yuan2cent(this.formData.orders_total_money)});return this.ordersId||(e.orders_no="XTD"+this.$common.format(new Date,"yyyyMMddhhmmssS")),e},getOrdersGoods(){const e=this.$refs.goodsTable.getListData();return e.map(e=>{const t=Object.assign({},e,{goods_price:this.$common.yuan2cent(e.goods_price),total_money:this.$common.yuan2cent(e.total_money)});return delete t.goods_ori_price,delete t.total_ori_money,delete t.goods_rate,t})}}},c=m,_=a("2877"),h=Object(_["a"])(c,o,r,!1,null,null,null);t["default"]=h.exports}}]);