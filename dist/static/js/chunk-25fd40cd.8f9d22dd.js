(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-25fd40cd"],{"168a":function(e,t,o){"use strict";var a=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",[o("el-select",e._b({staticClass:"w-full",attrs:{filterable:"",placeholder:e.$attrs.placeholder||"输入订单号查询",clearable:e.$attrs.clearable||!0,remote:"","remote-method":e.remoteMethod,loading:e.loading},on:{change:e.change,focus:e.initLoad},model:{value:e.modelValue,callback:function(t){e.modelValue=t},expression:"modelValue"}},"el-select",e.$attrs,!1),e._l(e.dataList,(function(t){return o("el-option",{key:t.value,attrs:{label:t.name,value:t.value}},[o("div",{staticClass:"dflex-b"},[o("div",[e._v(" "+e._s(t.orders_no)+" ")])])])})),1)],1)},r=[],s=(o("d81d"),o("b0c0"),o("4de4"),o("d3b7"),o("2197")),n={name:"AuxSelectOrders",props:{value:{type:[String,Array],default:function(){return""}},ordersTarget:{type:String,default:"",required:!0},ordersType:{type:String,default:"sales",required:!0,validator:function(e){return-1!==["sales","purchase"].indexOf(e)}},reqParams:{type:Object,default:function(){return{}}}},data:function(){return{loading:!1,dataList:[],modelValue:""}},watch:{value:{handler:function(e,t){this.modelValue=e},immediate:!0},ordersTarget:{handler:function(e,t){this.dataList=[]},immediate:!0}},methods:{initLoad:function(){this.dataList.length>0||this.fetchData()},fetchData:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.loading=!0;var o=Object.assign({ordersNo:t},this.reqParams,{pageSize:10});"sales"===this.ordersType?o.storeId=this.ordersTarget:"sales"===this.ordersType&&(o.supplierId=this.ordersTarget);var a={sales:"orders/listOrders",purchase:"purchase/listOrders"},r=a[this.ordersType];Object(s["a"])(r,o,{functionName:"xunda"}).then((function(t){e.loading=!1,e.dataList=(t.data||[]).map((function(e){return e.name=e.orders_no||"",e.value=e._id,e}))}))},remoteMethod:function(e){var t=this;e&&""!==e?(clearTimeout(this.timer),this.timer=setTimeout((function(){t.fetchData(e)}),200)):this.dataList=[]},change:function(){var e=this;this.$nextTick((function(){e.$emit("input",e.modelValue);var t=e.dataList.filter((function(t){return t.value===e.modelValue}));t.length>0&&e.$emit("change",t[0])}))}}},d=n,i=o("2877"),l=Object(i["a"])(d,a,r,!1,null,null,null);t["a"]=l.exports},d413:function(e,t,o){"use strict";o.r(t);var a=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{staticClass:"app-container"},[o("el-form",{ref:"formData",attrs:{model:e.formData,rules:e.rules,"label-width":"90px","label-align":"left",inline:!0}},[o("div",{staticClass:"aux-card"},[o("div",{staticClass:"header"},[o("div",{staticClass:"left title"},[e._v("销售退单")]),o("div",{staticClass:"right"},[o("el-button",{attrs:{type:"default",icon:"el-icon-tickets"},on:{click:function(t){return e.$common.closePage()}}},[e._v("取消")]),o("el-button",{attrs:{type:"primary",icon:"el-icon-document-checked"},on:{click:e.handleSave}},[e._v("保存 (Ctrl+S)")])],1)]),o("div",{staticClass:"margin-top-sm"},[o("div",{staticClass:"dflex-s"},[o("el-form-item",{attrs:{label:"选择客户",prop:"store_id"}},[o("AuxStoreSelect",{staticStyle:{width:"260px"},on:{change:e.changeStoreSelect},model:{value:e.formData.store_id,callback:function(t){e.$set(e.formData,"store_id",t)},expression:"formData.store_id"}})],1),o("el-form-item",{attrs:{label:"原销售单",prop:"rel_orders_id"}},[o("AuxOrdersSelect",{staticStyle:{width:"260px"},attrs:{"orders-type":"sales","orders-target":e.formData.store_id,"req-params":{settleState:"unsettle",dateSort:"desc"},disabled:!e.formData.store_id},on:{change:e.changeOrdersSelect},model:{value:e.formData.rel_orders_id,callback:function(t){e.$set(e.formData,"rel_orders_id",t)},expression:"formData.rel_orders_id"}})],1),o("el-form-item",{attrs:{label:"开单日期",prop:"orders_date"}},[o("el-date-picker",{staticStyle:{width:"260px"},attrs:{type:"datetime","value-format":"timestamp"},model:{value:e.formData.orders_date,callback:function(t){e.$set(e.formData,"orders_date",t)},expression:"formData.orders_date"}})],1),o("el-form-item",{attrs:{label:"业务员"}},[o("AuxMemberSelect",{model:{value:e.formData.sale_manid,callback:function(t){e.$set(e.formData,"sale_manid",t)},expression:"formData.sale_manid"}})],1)],1)]),o("refund-orders-goods-table",{ref:"goodsTable",on:{change:e.changeOrdersGoodsCompleted}})],1),o("div",{staticClass:"aux-card margin-top-sm"},[o("div",{staticClass:"padding-top"},[o("el-form-item",{attrs:{label:"其他费用"}},[o("el-input",{attrs:{oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",placeholder:"其他费用"},on:{change:e.changeOrdersCompleted},model:{value:e.formData.orders_extend_fee,callback:function(t){e.$set(e.formData,"orders_extend_fee",t)},expression:"formData.orders_extend_fee"}},[o("template",{slot:"append"},[e._v("元")])],2)],1),o("el-form-item",{attrs:{label:"退单金额"}},[o("el-input",{attrs:{disabled:"",placeholder:"金额"},model:{value:e.formData.orders_total_money,callback:function(t){e.$set(e.formData,"orders_total_money",t)},expression:"formData.orders_total_money"}},[o("template",{slot:"append"},[e._v("元")])],2)],1)],1),o("div",{staticClass:"dflex-e padding border-top"},[o("span",{staticClass:"padding-left"},[e._v("其他费用："+e._s(e.formData.orders_extend_fee))]),o("span",{staticClass:"padding-left"},[e._v("退单金额："+e._s(e.formData.orders_total_money))])])]),o("div",{staticClass:"aux-card margin-top"},[o("div",{staticClass:"header"},[o("span",{staticClass:"left title"},[e._v("其他信息")])]),o("div",{staticClass:"padding-top"},[o("el-form-item",{attrs:{label:"退单原因"}},[o("el-select",{attrs:{placeholder:"请选择退单原因",clearable:""},model:{value:e.formData.reason_type,callback:function(t){e.$set(e.formData,"reason_type",t)},expression:"formData.reason_type"}},e._l(e.$constant.REFUND_REASON_TYPES,(function(e){return o("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1)],1),99==e.formData.reason_type?o("div",[o("el-form-item",{attrs:{label:"原因说明"}},[o("el-input",{staticStyle:{width:"40vw"},attrs:{type:"textarea",placeholder:"请填写退单说明",maxlength:"300","show-word-limit":""},model:{value:e.formData.reason_content,callback:function(t){e.$set(e.formData,"reason_content",t)},expression:"formData.reason_content"}})],1)],1):e._e(),o("el-form-item",{attrs:{label:"备注信息",inline:!1}},[o("el-input",{staticStyle:{width:"80vw"},attrs:{type:"textarea",placeholder:"请填写备注信息",maxlength:"600","show-word-limit":""},model:{value:e.formData.remark,callback:function(t){e.$set(e.formData,"remark",t)},expression:"formData.remark"}})],1)],1)])])],1)},r=[],s=o("c7eb"),n=o("1da1"),d=(o("b680"),o("a9e3"),o("d81d"),o("b0c0"),function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",[o("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.dataLoading,expression:"dataLoading"}],ref:"goodsTable",staticClass:"aux-table",attrs:{data:e.goodsList,border:"",fit:"","show-summary":"","summary-method":e.summaryMethod}},[o("el-table-column",{attrs:{type:"index",width:"50",align:"center",label:"序号"}}),o("el-table-column",{attrs:{width:"80",align:"center",label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("el-button",{staticStyle:{padding:"6px 12px"},attrs:{type:"default",size:"mini",icon:"el-icon-minus",disabled:1==e.goodsList.length&&0==t.$index,round:""},on:{click:function(o){return e.handleItemMinus(t.row,t.$index)}}})]}}])}),o("el-table-column",{attrs:{width:"280",align:"left",label:"商品名称/规格"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("div",[e._v(e._s(t.row.goods_name))]),t.row.goods_spec?o("div",{staticClass:"ft-xs ft-grey"},[e._v("规格："+e._s(t.row.goods_spec))]):e._e()]}}])}),o("el-table-column",{attrs:{width:"200",align:"left",label:"商品编号"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("span",[e._v(e._s(t.row.goods_no))])]}}])}),o("el-table-column",{attrs:{width:"120",align:"center",label:"单位"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(t.row.goods_unit))]}}])}),o("el-table-column",{attrs:{width:"120",align:"right",label:"数量",prop:"goods_cnt"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("el-input",{staticClass:"tar",attrs:{disabled:!t.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"数量"},on:{blur:e.changeCompleted},model:{value:t.row.goods_cnt,callback:function(o){e.$set(t.row,"goods_cnt",o)},expression:"scope.row.goods_cnt"}})]}}])}),o("el-table-column",{attrs:{width:"120",align:"right",label:"单价(元)"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("el-input",{staticClass:"tar",attrs:{disabled:!t.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"单价"},on:{blur:function(o){return e.changeItemGoodsPrice(t.row)}},model:{value:t.row.goods_price,callback:function(o){e.$set(t.row,"goods_price",o)},expression:"scope.row.goods_price"}})]}}])}),o("el-table-column",{attrs:{width:"120",align:"right",label:"金额小计(元)",prop:"total_money"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("span",[e._v(e._s(t.row.total_money))])]}}])}),o("el-table-column",{attrs:{width:"160",align:"center",label:"退货原因"},scopedSlots:e._u([{key:"default",fn:function(t){return[o("el-select",{attrs:{placeholder:"非必填",clearable:""},model:{value:t.row.reon,callback:function(o){e.$set(t.row,"reon",o)},expression:"scope.row.reon"}},e._l(e.$constant.REFUND_REASON_TYPES,(function(e){return o("el-option",{key:e.value,attrs:{label:e.name,value:e.value}})})),1)]}}])}),o("el-table-column",{attrs:{align:"left",label:"备注","show-overflow-tooltip":""},scopedSlots:e._u([{key:"default",fn:function(t){return[o("el-popover",{attrs:{placement:"top-start",title:"编辑备注信息",width:"300",trigger:"click"}},[o("el-input",{attrs:{type:"textarea",rows:2,placeholder:"请输入备注"},model:{value:t.row.remark,callback:function(o){e.$set(t.row,"remark",o)},expression:"scope.row.remark"}}),o("span",{staticClass:"link-hover ft-primary",attrs:{slot:"reference"},slot:"reference"},[e._v(" "+e._s(t.row.remark||"添加备注")+" ")])],1)]}}])})],1),o("div",{staticClass:"dflex-b padding"},[o("div",{staticClass:"dflex-s"}),o("div",{staticClass:"dflex-e"},[o("span",{staticClass:"padding-left-lg"},[e._v("商品数量："+e._s(e.goodsTotalCount))]),o("span",{staticClass:"padding-left-lg"},[e._v("商品总额："+e._s(e.goodsTotalMoney.toFixed(2)))])])])],1)}),i=[],l=(o("a434"),o("d3b7"),o("159b"),o("13d5"),o("4de4"),o("caad"),{components:{},data:function(){return{dataLoading:!1,goodsList:[],goodsTotalCount:0,goodsOriginalMoney:0,goodsTotalMoney:0,goodsUnitPricesMap:{}}},methods:{handleItemMinus:function(e,t){1!==this.goodsList.length&&(this.goodsList.splice(t,1),this.changeCompleted())},initData:function(e){var t=this;this.goodsList=e.map((function(e){return t.initItemGoods(e)})),this.changeCompleted()},initItemGoods:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o={goods_id:e.goods_id||e._id||"",goods_sku_id:e.goods_id||e.sku_id||"",goods_no:e.goods_no||e.code||"",goods_name:e.goods_name||e.name||"",goods_spec:e.goods_spec||e.spec||"",goods_cnt:e.goods_cnt||t.goods_cnt||0,goods_unit:e.goods_unit||e.unit||"",goods_price:e.goods_price||0,total_money:e.total_money||0,remark:e.remark||t.remark||""};return o},changeItemGoodsPrice:function(e){this.changeCompleted()},changeCompleted:function(){this.goodsList.forEach((function(e){e.goods_cnt=Number(e.goods_cnt||0),e.goods_price=Number(e.goods_price||0).toFixed(2),e.total_money=(e.goods_cnt*e.goods_price).toFixed(2)})),this.goodsTotalCount=this.goodsList.reduce((function(e,t){return e+t.goods_cnt}),0),this.goodsTotalMoney=this.goodsList.reduce((function(e,t){return e+Number(t.total_money)}),0),this.$emit("change")},getSummaryData:function(){return{goodsTotalCount:this.goodsTotalCount,goodsTotalMoney:this.goodsTotalMoney}},getListData:function(){return this.goodsList.filter((function(e){return!!e.goods_name&&!!e.goods_cnt}))},summaryMethod:function(e){var t=e.columns,o=e.data,a=[];return t.forEach((function(e,t){if(0!==t)if(["goods_cnt","total_money"].includes(e.property)){var r=o.map((function(t){return Number(t[e.property])}));r.every((function(e){return isNaN(e)}))?a[t]="":(a[t]=r.reduce((function(e,t){return e+t}),0),["total_money"].includes(e.property)&&(a[t]=a[t].toFixed(2)))}else a[t]=" ";else a[t]="合计"})),a}}}),c=l,u=o("2877"),m=Object(u["a"])(c,d,i,!1,null,null,null),_=m.exports,f=o("2051"),g=o("168a"),p=o("b866"),h=o("2197"),b={components:{"refund-orders-goods-table":_,AuxStoreSelect:f["a"],AuxOrdersSelect:g["a"],AuxMemberSelect:p["a"]},data:function(){return{permission:"sales-orders-refund-create",ordersId:"",formData:{orders_date:(new Date).getTime(),orders_no:"",store_id:"",store:{_id:"",name:""},orders_goods:[],sale_manid:"",remark:"",create_uname:"",goods_total_count:0,goods_total_money:0,orders_extend_fee:0,orders_total_money:0,rel_orders_id:"",rel_orders:{},reason_type:10,reason_content:""},rules:{store_id:[{required:!0,message:"请选择客户信息",trigger:"change, blur"}],rel_orders_id:[{required:!0,message:"请选择原销售单",trigger:"change, blur"}],orders_date:[{required:!0,message:"请填写开单日期",trigger:"change, blur"}]}}},computed:{},mounted:function(){var e=this.$route.query||{},t=e.storeId,o=e.id;t&&(this.formData.store_id=t),o&&(this.ordersId=o,this.fetchDetail())},methods:{fetchDetail:function(){var e=this;Object(h["a"])("orders/getOrders",{ordersId:this.ordersId},{functionName:"xunda"}).then((function(t){e.initOrdersData(t.data)}))},initOrdersData:function(e){var t={};t.store_id=e.store_id,t.store=e.store,t.orders_date=e.orders_date,t.orders_no=e.orders_no,t.remark=e.remark,t.create_uname=e.create_uname,t.orders_total_money=Number((e.orders_total_money||0)/100).toFixed(2),t.orders_extend_fee=Number((e.orders_extend_fee||0)/100).toFixed(2),t.goods_total_count=e.goods_total_count||e.orders_goods_count,t.goods_total_money=Number((e.goods_total_money||t.orders_total_money)/100).toFixed(2),t.orders_goods=e.orders_goods.map((function(e){var t=Object.assign({},e);return t.total_money=(e.total_money/100).toFixed(2),t.goods_price=(e.goods_price/100).toFixed(2),t})),this.$refs.goodsTable.initData(t.orders_goods),this.formData=t},changeStoreSelect:function(e){this.formData.store_id=e._id,this.formData.store={_id:e._id,name:e.name,contact:e.contact,telephone:e.telephone},this.formData.rel_orders_id="",this.$refs.goodsTable.initData([]),this.changeOrdersCompleted()},changeOrdersSelect:function(e){this.formData.rel_orders_id=e._id,this.formData.rel_orders={orders_no:e.orders_no,orders_id:e._id};var t=e.orders_goods.map((function(e){var t=Object.assign({},e);return t.total_money=(e.total_money/100).toFixed(2),t.goods_price=(e.goods_price/100).toFixed(2),t}));this.$refs.goodsTable.initData(t),this.changeOrdersCompleted()},changeOrdersGoodsCompleted:function(){var e=this.$refs.goodsTable.getSummaryData(),t=e.goodsTotalCount,o=void 0===t?0:t,a=e.goodsTotalMoney,r=void 0===a?0:a;this.formData.goods_total_count=o,this.formData.goods_total_money=r,this.changeOrdersCompleted()},changeOrdersCompleted:function(){this.formData.orders_discount_money=(Number(this.formData.orders_discount_money)||0).toFixed(2),this.formData.orders_extend_fee=(Number(this.formData.orders_extend_fee)||0).toFixed(2),this.formData.orders_total_money=(Number(this.formData.goods_total_money)+Number(this.formData.orders_extend_fee)).toFixed(2)},validateForm:function(){var e=this.$refs.goodsTable.getListData();if(0!==e.length)return!0;this.$message.error("商品清单为空")},handleSave:function(){var e=this;this.$refs["formData"].validate((function(t){t&&e.validateForm()&&e.submitForm()}))},submitForm:function(){var e=this;return Object(n["a"])(Object(s["a"])().mark((function t(){var o;return Object(s["a"])().wrap((function(t){while(1)switch(t.prev=t.next){case 0:o={ordersId:e.ordersId,data:e.getOrdersData()},Object(h["a"])("orders/createRefundOrders",o,{functionName:"xunda"}).then((function(t){e.$message("保存成功"),setTimeout((function(){e.$router.push({path:"./refund-orders-detail/"+t.data})}),200)}),(function(t){e.$message.error(t.message)}));case 2:case"end":return t.stop()}}),t)})))()},getOrdersData:function(){var e=Object.assign({},this.formData,{orders_goods:this.getOrdersGoods(),goods_total_count:this.formData.goods_total_count,goods_total_money:100*this.formData.goods_total_money,orders_extend_fee:100*this.formData.orders_extend_fee,orders_total_money:100*this.formData.orders_total_money});return this.ordersId||(e.orders_no="XTD"+this.$common.format(new Date,"yyyyMMddhhmmssS")),e},getOrdersGoods:function(){var e=this.$refs.goodsTable.getListData();return e.map((function(e){return Object.assign({},e,{goods_ori_price:100*e.goods_ori_price,goods_price:100*e.goods_price,total_money:100*e.total_money,total_ori_money:100*e.total_ori_money})}))}}},v=b,y=Object(u["a"])(v,a,r,!1,null,null,null);t["default"]=y.exports}}]);