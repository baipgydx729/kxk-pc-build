(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-1b1ad99e"],{"3eaa":function(t,e,o){},"8c65":function(t,e,o){"use strict";o.r(e);var s=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"app-container"},[o("div",{staticClass:"aux-card"},[o("div",{staticClass:"header"},[t._m(0),o("div",{staticClass:"right"},[o("el-button",{attrs:{type:"default",icon:"el-icon-tickets"}},[t._v("取消")]),o("el-button",{attrs:{type:"primary",icon:"el-icon-document-checked"},on:{click:t.handleSave}},[t._v("保存 (Ctrl+S)")])],1)]),o("div",{staticClass:"margin-top-sm"},[o("el-form",{ref:"baseForm",attrs:{"label-width":"90px","label-align":"left",inline:!0}},[o("div",{staticClass:"dflex-s"},[o("el-form-item",{attrs:{label:"入库存日期"}},[o("el-date-picker",{staticStyle:{width:"300px"},attrs:{type:"datetime","value-format":"timestamp",clearable:!1},model:{value:t.baseForm.opt_time,callback:function(e){t.$set(t.baseForm,"opt_time",e)},expression:"baseForm.opt_time"}})],1),o("el-form-item",{attrs:{label:"入库类型"}},[o("el-select",{staticStyle:{width:"300px"},attrs:{placeholder:"选择入库类型"},model:{value:t.baseForm.opt_type,callback:function(e){t.$set(t.baseForm,"opt_type",e)},expression:"baseForm.opt_type"}},t._l(t.compTypeOptions,(function(t){return o("el-option",{key:t.value,attrs:{label:t.name,value:t.value}})})),1)],1),o("el-form-item",{attrs:{label:"入库仓库"}},[o("AuxWarehouseSelect",{staticStyle:{width:"300px"},model:{value:t.baseForm.warehouse_id,callback:function(e){t.$set(t.baseForm,"warehouse_id",e)},expression:"baseForm.warehouse_id"}})],1)],1)])],1),o("orders-goods-table",{ref:"goodsTable",on:{change:t.changeOrdersGoodsCompleted}})],1),o("el-card",{staticClass:"aux-card margin-top",attrs:{shadow:"none","body-style":{padding:"12px"}}},[o("div",{attrs:{slot:"header"},slot:"header"},[o("span",[t._v("备注信息")])]),o("el-input",{attrs:{type:"textarea",placeholder:"请填写备注内容",maxlength:"600","show-word-limit":""},model:{value:t.baseForm.remark,callback:function(e){t.$set(t.baseForm,"remark",e)},expression:"baseForm.remark"}})],1)],1)},n=[function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"left"},[o("span",{staticClass:"title"},[t._v("商品入库")])])}],a=o("c7eb"),i=o("1da1"),r=(o("4de4"),o("d3b7"),o("caad"),o("13d5"),o("d81d"),o("b680"),o("a9e3"),function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"orders-goods-table"},[o("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.dataLoading,expression:"dataLoading"}],ref:"goodsTable",staticClass:"aux-table",attrs:{data:t.goodsList,border:"",fit:"","show-summary":"","summary-method":t.summaryMethod}},[o("el-table-column",{attrs:{type:"index",width:"50",align:"center",label:"序号"}}),o("el-table-column",{attrs:{width:"120",align:"center",label:"操作"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-button",{staticStyle:{padding:"6px 12px"},attrs:{type:"default",size:"mini",icon:"el-icon-plus",round:""},on:{click:function(o){return t.handleItemPlus(e.row,e.$index)}}}),o("el-button",{staticStyle:{padding:"6px 12px"},attrs:{type:"default",size:"mini",icon:"el-icon-minus",round:""},on:{click:function(o){return t.handleItemMinus(e.row,e.$index)}}})]}}])}),o("el-table-column",{attrs:{width:"280",align:"left",label:"商品名称"},scopedSlots:t._u([{key:"default",fn:function(e){return[e.row.goods_name?o("div",{staticClass:"dflex"},[o("div",{staticClass:"goods-img"},[o("img",{attrs:{src:e.row.goods_img||"/static/img/img-empty.png",alt:""}})]),o("div",{staticClass:"flex1"},[o("div",[t._v(t._s(e.row.goods_name))]),e.row.goods_no?o("div",{staticClass:"fs-xs ft-grey"},[t._v("No："+t._s(e.row.goods_no))]):t._e()])]):o("div",[o("AuxGoodsSelectPopoer",{attrs:{"main-price":"bid_price"},on:{change:function(o){return t.changeItemGoods(o,e.row)}},model:{value:e.row.goods_id,callback:function(o){t.$set(e.row,"goods_id",o)},expression:"scope.row.goods_id"}})],1)]}}])}),o("el-table-column",{attrs:{width:"200",align:"left",label:"规格/属性"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("span",[t._v(t._s(e.row.goods_spec))])]}}])}),o("el-table-column",{attrs:{width:"130",align:"center",label:"单位"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-select",{attrs:{disabled:!e.row.goods_name,placeholder:"单位"},on:{focus:function(o){return t.remoteItemGoodsUnitMethod(e.row)},change:function(o){return t.changeItemGoodsUnit(e.row)}},model:{value:e.row.goods_unit,callback:function(o){t.$set(e.row,"goods_unit",o)},expression:"scope.row.goods_unit"}},t._l(t.getItemGoodsUnitOptions(e.row.goods_id),(function(e){return o("el-option-group",{key:e.label,attrs:{label:e.label}},t._l(e.children,(function(e){return o("el-option",{key:e.unit,attrs:{label:e.unit+(e.unit_desc||""),value:e.unit}},[o("span",[t._v(t._s(e.unit)+t._s(e.unit_desc))])])})),1)})),1)]}}])}),o("el-table-column",{attrs:{width:"120",align:"center",label:"数量",prop:"goods_cnt"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-input",{staticClass:"tac",attrs:{disabled:!e.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"数量"},on:{blur:t.changeOrdersCompleted},model:{value:e.row.goods_cnt,callback:function(o){t.$set(e.row,"goods_cnt",o)},expression:"scope.row.goods_cnt"}})]}}])}),o("el-table-column",{attrs:{width:"120",align:"right",label:"单价(元)"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-input",{staticClass:"tar",attrs:{disabled:!e.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"单价"},on:{blur:function(o){return t.changeItemGoodsPrice(e.row)}},model:{value:e.row.goods_price,callback:function(o){t.$set(e.row,"goods_price",o)},expression:"scope.row.goods_price"}})]}}])}),o("el-table-column",{attrs:{width:"120",align:"right",label:"金额小计(元)",prop:"total_money"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(e.row.total_money))]}}])}),o("el-table-column",{attrs:{align:"left",label:"备注","show-overflow-tooltip":""},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-popover",{attrs:{placement:"top-start",title:"编辑备注信息",width:"300",trigger:"click"}},[o("el-input",{attrs:{type:"textarea",rows:2,placeholder:"请输入备注"},model:{value:e.row.remark,callback:function(o){t.$set(e.row,"remark",o)},expression:"scope.row.remark"}}),o("span",{staticClass:"link-hover ft-primary",attrs:{slot:"reference"},slot:"reference"},[t._v(" "+t._s(e.row.remark||"编辑")+" ")])],1)]}}])})],1),o("div",{staticClass:"dflex-b padding"},[o("div",{staticClass:"dflex-s"},[o("el-button",{attrs:{type:"primary",size:"small",icon:"el-icon-plus"},on:{click:t.handleSelectAdd}},[t._v("选择商品")]),t.scanForm.visible?o("el-input",{ref:"scanInput",staticClass:"margin-lr-sm",staticStyle:{width:"260px"},attrs:{clearable:"",size:"small",placeholder:"请扫描商品编码或条形码"},nativeOn:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleScanAdd(e)}},model:{value:t.scanForm.keyword,callback:function(e){t.$set(t.scanForm,"keyword",e)},expression:"scanForm.keyword"}}):t._e(),o("el-button",{attrs:{type:"default",size:"small",icon:"el-icon-full-screen"},on:{click:t.handleScanOpen}},[t._v(" "+t._s(t.scanForm.visible?"取消扫码":"扫码录入")+" ")])],1),o("div",{staticClass:"dflex-e"},[o("span",{staticClass:"padding-left-lg"},[t._v("商品数量："+t._s(t.goodsTotalCount))]),o("span",{staticClass:"padding-left-lg"},[t._v("商品总额："+t._s(t.goodsTotalMoney.toFixed(2)))])])]),o("AuxGoodsSelectDialog",{ref:"auxGoodsSelectDialog",attrs:{"main-price":"bid_price"},on:{onSuccess:t.selectedGoodsSuccess}})],1)}),d=[],l=o("2909"),c=(o("498a"),o("159b"),o("a434"),o("b0c0"),o("2197")),u=o("c031"),m=o("b122"),g=o("15f6"),p=o("e5bb"),f={components:{AuxGoodsSelectPopoer:g["a"],AuxGoodsSelectDialog:m["a"]},data:function(){return{dataLoading:!1,goodsList:[this.formatItemGoods()],goodsSelectIds:[],goodsSaleGrade:0,goodsTotalCount:0,goodsOriginalMoney:0,goodsDiscountMoney:0,goodsTotalMoney:0,goodsUnitMap:{},scanForm:{visible:!1,keyword:""}}},methods:{initData:function(t){var e=this;this.goodsList=t.map((function(t){return e.formatItemGoods(t)})),this.changeOrdersCompleted()},handleScanOpen:function(){var t=this;this.scanForm.visible=!this.scanForm.visible,this.scanForm.visible&&this.$nextTick((function(){t.$refs.scanInput.focus()}))},handleScanAdd:function(){var t=this,e=this.scanForm.keyword.trim();e&&(this.scanForm.keyword="",Object(c["a"])("goods/getGoodsByCode",{code:e},{functionName:"xunda"}).then((function(e){var o=t.formatItemGoods(e.data,{remark:"",goods_cnt:1});t.initGoodsUnit(o),t.goodsList.push(o)})))},handleSelectAdd:function(){this.$refs.auxGoodsSelectDialog.open()},selectedGoodsSuccess:function(t){var e=this;t.forEach((function(t){e.initGoodsUnit(t),e.goodsList.push(e.formatItemGoods(t,{remark:"",goods_cnt:t.goods_cnt}))})),this.changeOrdersCompleted()},handleItemPlus:function(t,e){this.goodsList.splice(e+1,0,this.formatItemGoods())},handleItemMinus:function(t,e){this.goodsList.splice(e,1),0===this.goodsList.length&&this.goodsList.push(this.formatItemGoods()),this.changeOrdersCompleted()},initGoodsUnit:function(t){this.goodsUnitMap[t._id]=t.unit_list||[]},formatItemGoods:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.goods_price||(t.bid_price||0)/100,s={goods_id:t.goods_id||t._id||"",goods_sku_id:t.goods_sku_id||t.sku_id||"",goods_no:t.goods_no||t.code||"",goods_img:t.goods_img||t.img||"",goods_name:t.goods_name||t.name||"",goods_spec:t.goods_spec||t.spec||"",goods_cnt:t.goods_cnt||e.goods_cnt||0,goods_unit:t.goods_unit||t.unit||"",goods_price:o,total_money:t.total_money||0,remark:t.remark||e.remark||""};return s},changeItemGoods:function(t,e){var o=this;e.goodsId||(t.goods?(Object.assign(e,this.formatItemGoods(t.goods,{remark:e.remark,goods_cnt:1})),this.initGoodsUnit(t.goods),this.changeOrdersCompleted()):Object(c["a"])("goods/getInfo",{goods_id:e.goods_id},{functionName:"xunda"}).then((function(t){var s=Object.assign(e,o.formatItemGoods(t.data,{remark:e.remark,goods_cnt:1}));o.initGoodsUnit(s),o.changeOrdersCompleted()})))},getItemGoodsUnitOptions:function(t){if(!t)return[];var e=this.goodsUnitMap[t]||[];if(0===e.length)return[];var o=[{label:"默认单位",children:e.filter((function(t){return 1===t.scale}))}],s=e.filter((function(t){return 1!==t.scale}));return s.length>0&&o.push({label:"辅助单位",children:s}),o},remoteItemGoodsUnitMethod:function(t){var e=this;if(t.goods_id){var o=this.goodsUnitMap[t.goods_id]||[];o.length>1||Object(c["a"])("goods/getInfo",{goods_id:t.goods_id},{functionName:"xunda"}).then((function(t){var o=t.data;e.goodsUnitMap[o._id]=o.unit_list,Object(u["f"])(o),e.goodsList=Object(l["a"])(e.goodsList)}))}},changeItemGoodsUnit:function(t){if(t.goods_id){var e=this.goodsUnitMap[t.goods_id]||[],o=e.filter((function(e){return e.unit===t.goods_unit}));if(0!==o.length){var s=o[0],n=Object(u["b"])(t.goods_id);if(n){var a=p["a"].mul(n.bid_price,s.scale),i=n.sku_datas.filter((function(e){return e.name===t.goods_spec}));if(i.length>0){var r=i.filter((function(e){return e.unit===t.goods_unit}));r.length>0&&(a=r[0].bid_price||0)}var d=Number(a/100);t.goods_price=d,this.changeOrdersCompleted()}}}},changeItemGoodsPrice:function(t){this.changeOrdersCompleted()},changeOrdersCompleted:function(){this.goodsList.forEach((function(t){t.goods_cnt=Number(t.goods_cnt||0),t.goods_price=Number(t.goods_price||0).toFixed(2),t.total_money=(t.goods_cnt*t.goods_price).toFixed(2)})),this.goodsTotalCount=this.goodsList.reduce((function(t,e){return t+e.goods_cnt}),0),this.goodsTotalMoney=this.goodsList.reduce((function(t,e){return t+Number(e.total_money)}),0),this.goodsDiscountMoney=this.goodsOriginalMoney-this.goodsTotalMoney,this.$emit("change")},getSummaryData:function(){return{goodsTotalCount:this.goodsTotalCount,goodsDiscountMoney:this.goodsDiscountMoney,goodsTotalMoney:this.goodsTotalMoney}},getListData:function(){return this.goodsList.filter((function(t){return!!t.goods_name}))},summaryMethod:function(t){var e=t.columns,o=t.data,s=[];return e.forEach((function(t,e){if(0!==e)if(["goods_cnt","total_money"].includes(t.property)){var n=o.map((function(e){return Number(e[t.property])}));n.every((function(t){return isNaN(t)}))?s[e]="":(s[e]=n.reduce((function(t,e){return t+e}),0),["total_money"].includes(t.property)&&(s[e]=s[e].toFixed(2)))}else s[e]=" ";else s[e]="合计"})),s}}},h=f,_=(o("ab2d"),o("2877")),b=Object(_["a"])(h,r,d,!1,null,null,null),v=b.exports,y=o("c3dd"),w={components:{"orders-goods-table":v,AuxWarehouseSelect:y["a"]},data:function(){return{permission:"into-stock",ordersId:"",baseForm:{opt_time:(new Date).getTime(),opt_no:"",opt_type:1,orders_goods:[],remark:"",create_uname:"",goods_total_count:0,goods_total_money:0,total_price:0}}},computed:{compTypeOptions:function(){return this.$constant.STOCK_OPT_TYPES.filter((function(t){return[1,9].includes(t.value)}))}},methods:{changeOrdersGoodsCompleted:function(){var t=this.$refs.goodsTable.getSummaryData(),e=t.goodsTotalCount,o=void 0===e?0:e,s=t.goodsTotalMoney,n=void 0===s?0:s;this.baseForm.goods_total_count=o,this.baseForm.goods_total_money=n,this.changeOrdersCompleted()},changeOrdersCompleted:function(){var t=this.getOrdersGoods(),e=t.reduce((function(t,e){return t+e.total_money}),0);this.baseForm.total_price=e},validateForm:function(){if(this.baseForm.opt_time)if(this.baseForm.opt_type)if(this.baseForm.warehouse_id){var t=this.$refs.goodsTable.getListData();if(0!==t.length)return!0;this.$message.error("商品清单为空")}else this.$message.error("请选择存放的仓库");else this.$message.error("请填选择入库方式");else this.$message.error("请填写入库日期")},handleSave:function(){this.validateForm()&&this.submitForm(!1)},submitForm:function(){var t=this;return Object(i["a"])(Object(a["a"])().mark((function e(){var o;return Object(a["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:o=t.getOrdersData(),Object(c["a"])("stock/intoOrders",o,{functionName:"xunda"}).then((function(e){t.$message("保存成功"),setTimeout((function(){t.$router.push({path:"./stock-orders-detail/"+e.data})}),500)}),(function(e){t.$message.error(e.message)}));case 2:case"end":return e.stop()}}),e)})))()},getOrdersData:function(){var t=Object.assign({},this.baseForm,{opt_time:this.baseForm.opt_time,opt_type:this.baseForm.opt_type,warehouse_id:this.baseForm.warehouse_id,remark:this.baseForm.remark,orders_goods:this.getOrdersGoods(),total_price:this.baseForm.total_price,create_uname:this.$store.getters.companyInfo.member_name});return t},getOrdersGoods:function(){var t=this.$refs.goodsTable.getListData();return t.map((function(t){var e=Object.assign({},t);return e.goods_price=100*Number(t.goods_price).toFixed(2),e.total_money=Number(t.goods_cnt)*Number(e.goods_price),e}))}}},k=w,x=Object(_["a"])(k,s,n,!1,null,null,null);e["default"]=x.exports},ab2d:function(t,e,o){"use strict";o("3eaa")}}]);