(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2f099456"],{"3c62":function(o,e,t){"use strict";t("6d38")},"6d38":function(o,e,t){},b7ac:function(o,e,t){"use strict";var s=function(){var o=this,e=o.$createElement,t=o._self._c||e;return t("div",{staticClass:"orders-goods-table"},[t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:o.loading,expression:"loading"}],ref:"goodsTable",staticClass:"aux-table",attrs:{data:o.goodsList,border:"",fit:"",stripe:"","row-key":"id"}},[t("el-table-column",{attrs:{type:"index",width:"50",align:"center",label:"序号"},scopedSlots:o._u([{key:"default",fn:function(e){return[t("span",{staticClass:"padding-xs drag-btn",staticStyle:{cursor:"move"}},[o._v(o._s(e.$index+1))])]}}])}),t("el-table-column",{attrs:{width:"120",align:"center",label:"操作"},scopedSlots:o._u([{key:"default",fn:function(e){return[t("el-button",{staticStyle:{padding:"6px 12px"},attrs:{type:"default",size:"mini",icon:"el-icon-plus",round:""},on:{click:function(t){return o.handleItemPlus(e.row,e.$index)}}}),t("el-button",{staticStyle:{padding:"6px 12px"},attrs:{type:"default",size:"mini",icon:"el-icon-minus",round:""},on:{click:function(t){return o.handleItemMinus(e.row,e.$index)}}})]}}])}),t("el-table-column",{attrs:{width:"280",align:"left",label:"商品名称"},scopedSlots:o._u([{key:"default",fn:function(e){return[e.row.goods_name?t("div",{staticClass:"dflex"},[t("div",{staticClass:"goods-img"},[t("img",{attrs:{src:e.row.goods_img||"/static/img/img-empty.png",alt:""}})]),t("div",{staticClass:"flex1"},[t("div",[t("el-popover",{attrs:{placement:"right",title:"商品名称",width:"300",trigger:"click"}},[t("el-input",{attrs:{type:"text",placeholder:"请输入商品名称"},model:{value:e.row.goods_name,callback:function(t){o.$set(e.row,"goods_name",t)},expression:"scope.row.goods_name"}}),t("span",{staticClass:"fs-sm",attrs:{slot:"reference"},slot:"reference"},[o._v(" "+o._s(e.row.goods_name)+" ")])],1)],1),t("el-popover",{attrs:{placement:"right",title:"商品编号",width:"300",trigger:"click"}},[t("el-input",{attrs:{type:"text",placeholder:"请输入商品编号"},model:{value:e.row.goods_no,callback:function(t){o.$set(e.row,"goods_no",t)},expression:"scope.row.goods_no"}}),t("span",{staticClass:"fs-xs ft-grey",attrs:{slot:"reference"},slot:"reference"},[o._v(" No："+o._s(e.row.goods_no)+" "),t("span",{staticClass:"el-icon-edit"})])],1)],1)]):t("div",[t("AuxGoodsSelectPopoer",{on:{change:function(t){return o.changeItemGoods(t,e.row)},submit:function(t){return o.changeItemGoodsName(t,e.row)}},model:{value:e.row.goods_id,callback:function(t){o.$set(e.row,"goods_id",t)},expression:"scope.row.goods_id"}})],1)]}}])}),t("el-table-column",{attrs:{width:"200",align:"left",label:"规格/属性"},scopedSlots:o._u([{key:"default",fn:function(e){return[e.row.goods_id?[t("el-popover",{attrs:{placement:"right",title:"规格/属性",width:"300",trigger:"click"}},[t("el-input",{attrs:{type:"text",placeholder:"请输入规格/属性"},model:{value:e.row.goods_spec,callback:function(t){o.$set(e.row,"goods_spec",t)},expression:"scope.row.goods_spec"}}),t("div",{staticClass:"ft-grey fs-xs padding-top-xs"},[o._v("更改规格/属性可能会影响该商品计算统计")]),t("span",{attrs:{slot:"reference"},slot:"reference"},[e.row.goods_spec?t("span",[o._v(o._s(e.row.goods_spec))]):t("span",{staticClass:"el-icon-edit"})])],1)]:[t("el-input",{attrs:{disabled:!e.row.goods_name,onfocus:"this.select();",placeholder:"规格/属性"},model:{value:e.row.goods_spec,callback:function(t){o.$set(e.row,"goods_spec",t)},expression:"scope.row.goods_spec"}})]]}}])}),t("el-table-column",{attrs:{width:"130",align:"center",label:"单位"},scopedSlots:o._u([{key:"default",fn:function(e){return[t("el-select",{attrs:{disabled:!e.row.goods_name,"allow-create":!e.row.goods_id,filterable:!e.row.goods_id,placeholder:"单位"},on:{focus:function(t){return o.remoteItemGoodsUnitMethod(e.row)},change:function(t){return o.changeItemGoodsUnit(e.row)}},model:{value:e.row.goods_unit,callback:function(t){o.$set(e.row,"goods_unit",t)},expression:"scope.row.goods_unit"}},o._l(o.getItemGoodsUnitOptions(e.row.goods_id),(function(e){return t("el-option-group",{key:e.label,attrs:{label:e.label}},o._l(e.children,(function(e){return t("el-option",{key:e.unit,attrs:{label:e.unit+(e.unit_desc||""),value:e.unit}},[t("span",[o._v(o._s(e.unit)+o._s(e.unit_desc))])])})),1)})),1)]}}])}),t("el-table-column",{attrs:{width:"120",align:"center",label:"数量",prop:"goods_cnt"},scopedSlots:o._u([{key:"default",fn:function(e){return[t("el-input",{staticClass:"tac",attrs:{disabled:!e.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"数量"},on:{blur:o.changeOrdersCompleted},model:{value:e.row.goods_cnt,callback:function(t){o.$set(e.row,"goods_cnt",t)},expression:"scope.row.goods_cnt"}})]}}])}),t("el-table-column",{attrs:{width:"120",align:"right",label:"原价(元)"},scopedSlots:o._u([{key:"default",fn:function(e){return[t("el-input",{staticClass:"tar",attrs:{disabled:!e.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"原价"},on:{blur:function(t){return o.changeItemGoodsOriPrice(e.row)}},model:{value:e.row.goods_ori_price,callback:function(t){o.$set(e.row,"goods_ori_price",t)},expression:"scope.row.goods_ori_price"}})]}}])}),t("el-table-column",{attrs:{width:"120",align:"right",label:"折扣(%)"},scopedSlots:o._u([{key:"default",fn:function(e){return[t("el-input",{staticClass:"tar",attrs:{disabled:!e.row.goods_name,min:"0",max:"100",oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"折扣"},on:{blur:function(t){return o.changeItemGoodsRate(e.row)}},model:{value:e.row.goods_rate,callback:function(t){o.$set(e.row,"goods_rate",t)},expression:"scope.row.goods_rate"}})]}}])}),t("el-table-column",{attrs:{width:"120",align:"right",label:"单价(元)"},scopedSlots:o._u([{key:"default",fn:function(e){return[t("el-input",{staticClass:"tar",attrs:{disabled:!e.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"单价"},on:{blur:function(t){return o.changeItemGoodsPrice(e.row)}},model:{value:e.row.goods_price,callback:function(t){o.$set(e.row,"goods_price",t)},expression:"scope.row.goods_price"}})]}}])}),t("el-table-column",{attrs:{width:"120",align:"right",label:"金额小计(元)",prop:"total_money"},scopedSlots:o._u([{key:"default",fn:function(e){return[o._v(o._s(e.row.total_money))]}}])}),t("el-table-column",{attrs:{align:"left",label:"备注","show-overflow-tooltip":""},scopedSlots:o._u([{key:"default",fn:function(e){return[t("el-popover",{attrs:{placement:"top-start",title:"备注信息",width:"300",trigger:"click"}},[t("el-input",{attrs:{type:"textarea",rows:2,placeholder:"请输入备注"},model:{value:e.row.remark,callback:function(t){o.$set(e.row,"remark",t)},expression:"scope.row.remark"}}),t("span",{staticClass:"link-hover ft-primary",attrs:{slot:"reference"},slot:"reference"},[o._v(" "+o._s(e.row.remark||"编辑")+" ")])],1)]}}])})],1),t("div",{staticClass:"dflex-b padding"},[t("div",{staticClass:"dflex-s"},[t("el-button",{attrs:{type:"primary",size:"small",icon:"el-icon-plus"},on:{click:o.handleSelectAdd}},[o._v("选择商品")]),o.scanForm.visible?t("el-input",{ref:"scanInput",staticClass:"margin-lr-sm",staticStyle:{width:"260px"},attrs:{clearable:"",size:"small",placeholder:"请扫描商品编码或条形码"},nativeOn:{keyup:function(e){return!e.type.indexOf("key")&&o._k(e.keyCode,"enter",13,e.key,"Enter")?null:o.handleScanAdd(e)}},model:{value:o.scanForm.keyword,callback:function(e){o.$set(o.scanForm,"keyword",e)},expression:"scanForm.keyword"}}):o._e(),t("el-button",{attrs:{type:"default",size:"small",icon:"el-icon-full-screen"},on:{click:o.handleScanOpen}},[o._v(" "+o._s(o.scanForm.visible?"取消扫码":"扫码录入")+" ")]),t("el-button",{attrs:{type:"default",size:"small",icon:"el-icon-folder-opened"},on:{click:o.handleImportAdd}},[o._v("导入商品")])],1),t("div",{staticClass:"dflex-e"},[t("span",{staticClass:"padding-left-lg"},[o._v("商品数量："+o._s(o.goodsTotalCount))]),t("span",{staticClass:"padding-left-lg"},[o._v("原价金额："+o._s(o.goodsOriginalMoney.toFixed(2)))]),t("span",{staticClass:"padding-left-lg"},[o._v("折扣优惠："+o._s(o.goodsDiscountMoney.toFixed(2)))]),t("span",{staticClass:"padding-left-lg"},[o._v("商品总额："+o._s(o.goodsTotalMoney.toFixed(2)))])])]),t("ImportGoodsDialog",{ref:"importGoodsDialog",on:{onSuccess:o.importGoodsSuccess}}),t("AuxGoodsSelectDialog",{ref:"auxGoodsSelectDialog",on:{onSuccess:o.selectedGoodsSuccess}})],1)},i=[],n=(t("13d5"),t("2197")),a=t("c031"),d=t("b122"),r=t("15f6"),l=function(){var o=this,e=o.$createElement,t=o._self._c||e;return t("el-dialog",{attrs:{title:"销售商品导入",visible:o.dialogVisible,width:"50%","before-close":o.close,"append-to-body":"","custom-class":"import-dialog"},on:{"update:visible":function(e){o.dialogVisible=e}}},[t("div",{directives:[{name:"loading",rawName:"v-loading",value:o.loadOpts.loading,expression:"loadOpts.loading"}],staticClass:"dialog-warpper",attrs:{"element-loading-text":o.loadOpts.loadtext}},[t("div",{staticClass:"grid-box-2"},[t("div",{staticClass:"flex1",on:{click:o.downloadTemp}},[t("span",[o._v("1.下载Excel模板")]),t("div",{staticClass:"box-item margin-top"},[t("div",{staticClass:"icon el-icon-document"}),t("div",{staticClass:"txt fs"},[o._v("点击下载Excel模板")])])]),t("div",{staticClass:"flex1"},[t("span",[o._v("2.上传Excel文件")]),t("div",{staticClass:"box-item margin-top"},[t("upload-excel-component",{attrs:{"skin-row":o.skinRow,"before-upload":o.beforeUpload,"on-success":o.uploadSuccess,"on-error":o.uploadError}})],1)])])]),o.errorMsg?t("div",{staticClass:"dialog-error"},[t("p",[o._v("异常错误")]),t("div",[o._v(o._s(o.errorMsg))])]):o._e(),t("div",{staticClass:"dialog-footer"},[t("p",[o._v("操作指引")]),t("p",[o._v("1、下载Excel模板，填写Excel表格;")]),t("p",[o._v("2、将文件拖动到虚线框 -> 系统自动检验数据;")]),t("p",[o._v("3、数据导入成功;")])])])},c=[],g=t("3796"),u=t("2a95");const p={"商品ID":{name:"goods_id",type:"string"},"商品图片":{name:"goods_img",type:"url",message:"商品图片必需是完整的Url地址"},"商品名称":{name:"goods_name",type:"any",required:!0,message:"商品名称不能为空"},"商品编号*":{name:"goods_no",type:"any",required:!0,message:"商品编号不能为空"},"规格":{name:"goods_spec",type:"string",message:"商品规格必需是字符"},"单位":{name:"goods_unit",type:"string",message:"商品单位不能为空"},"数量*":{name:"goods_cnt",type:"number",required:!0,validator:(o,e,t,s,i)=>{const n=/((^[1-9]\d*)|^0)(\.\d{0,2}){0,1}$/;n.test(e)||t("数量*必需为数字"),t()}},"折扣":{name:"goods_rate",type:"number",validator:(o,e,t,s,i)=>{const n=/((^[1-9]\d*)|^0)(\.\d{0,2}){0,1}$/;!e||n.test(e)?t():t("折扣必需为1~100内数字")}},"单价":{name:"goods_price",type:"number",message:"单价必需是数字"},"备注":{name:"remark",type:"string"}};function m(o,e){return Object.keys(o).forEach(t=>{const s=o[t],i=e[t];i&&(o[i.name]=i.handle?i.handle(s):s)}),o}async function h({header:o,dataList:e}){const t=new u["a"](p),s=e.map((o,e)=>new Promise((s,i)=>{t.validate(o,(t,n)=>{t&&i({errors:t,rowIndex:e}),s(m(o,p))})}));return await Promise.all(s)}var _={components:{UploadExcelComponent:g["a"]},props:{fileType:{type:String,default:()=>""}},data(){return{dialogVisible:!1,skinRow:1,loadOpts:{loading:!1,loadtext:"正在加载中"},downOpts:{fileName:"销售导入商品模板_"+(new Date).getTime()+".xlsx",tempUrl:location.protocol+"//"+location.host+"/static/excel/template/salesPrepareTemplate.xlsx"},tableHeader:[],tableData:[],errorMsg:""}},methods:{open(){this.dialogVisible=!0},close(){this.errorMsg="",this.dialogVisible=!1},downloadTemp(){const o=document.createElement("a");o.style.display="none",o.download=this.downOpts.fileName,o.href=this.downOpts.tempUrl,document.body.appendChild(o),o.click(),document.body.removeChild(o)},beforeUpload(o){this.errorMsg="",this.loadOpts.loading=!0;const e=o.size/1024/1024<1;return!!e||(this.$message({message:"请不要上传大于1M的文件",type:"warning"}),this.loadOpts.loading=!1,!1)},uploadSuccess({header:o,results:e}){this.tableHeader=o,this.tableData=e,this.loadOpts.loading=!0,this.loadOpts.loadtext="正在校验数据",h({header:o,dataList:e}).then(o=>{setTimeout(()=>{this.loadOpts.loading=!1,this.$emit("onSuccess",o),this.close()},1e3)}).catch(o=>{this.loadOpts.loading=!1;const{errors:e}=o;if(e){const o=e.map((o,e)=>e+1+"."+o.field+": "+o.message);this.errorMsg=o.join("; ")}})},uploadError(o){console.log(o),this.loadOpts.loading=!1}}},f=_,b=(t("e64f"),t("2877")),w=Object(b["a"])(f,l,c,!1,null,null,null),y=w.exports,v=t("e5bb"),x=t("aa47"),k=t("2f62"),C={components:{AuxGoodsSelectPopoer:r["a"],ImportGoodsDialog:y,AuxGoodsSelectDialog:d["a"]},props:{loading:{type:Boolean,default:!1}},data(){return{goodsList:[this.formatItemGoods()],goodsSelectIds:[],goodsSaleGrade:0,goodsTotalCount:0,goodsOriginalMoney:0,goodsDiscountMoney:0,goodsTotalMoney:0,goodsUnitMap:{},scanForm:{visible:!1,keyword:""}}},computed:{...Object(k["b"])(["dictionary"])},mounted(){const o=this,e=document.querySelector(".aux-table .el-table__body-wrapper table tbody");x["a"].create(e,{animation:150,ghostClass:"blue-background-class",handle:".drag-btn",onEnd(e){const t=[...o.goodsList],s=t[e.oldIndex];t[e.oldIndex]=t[e.newIndex],t[e.newIndex]=s,o.goodsList=[],o.$nextTick(()=>{o.goodsList=t}),console.log(o.goodsList)},onChoose(o){o.oldIndex},onUnchoose(o){}});this.$store.dispatch("dictionary/loadGoodsUnits")},methods:{initData(o){this.goodsList=o.map(o=>this.formatItemGoods(o)),this.changeOrdersCompleted()},handleScanOpen(){this.scanForm.visible=!this.scanForm.visible,this.scanForm.visible&&this.$nextTick(()=>{this.$refs.scanInput.focus()})},handleScanAdd(){const o=this.scanForm.keyword.trim();o&&(this.scanForm.keyword="",Object(n["a"])("goods/getGoodsByCode",{code:o},{functionName:"xunda"}).then(o=>{const e=this.formatItemGoods(o.data,{remark:"",goods_cnt:1});this.initGoodsUnit(e),this.goodsList.push(e)}))},handleSelectAdd(){this.$refs.auxGoodsSelectDialog.open()},selectedGoodsSuccess(o){o.forEach(o=>{this.initGoodsUnit(o),this.goodsList.push(this.formatItemGoods(o,{remark:"",goods_cnt:o.goods_cnt}))}),this.changeOrdersCompleted()},handleImportAdd(){this.$refs.importGoodsDialog.open()},importGoodsSuccess(o){o.forEach(o=>{const e=this.formatItemGoods(o);this.initGoodsUnit(e),this.goodsList.push(e)})},handleItemPlus(o,e){this.goodsList.splice(e+1,0,this.formatItemGoods())},handleItemMinus(o,e){this.goodsList.splice(e,1),0===this.goodsList.length&&this.goodsList.push(this.formatItemGoods()),this.changeOrdersCompleted()},initGoodsUnit(o){this.goodsUnitMap[o._id]=o.unit_list||[]},formatItemGoods(o={},e={}){const t=o.goods_price||this.$common.cent2yuan(o.price||0),s={goods_id:o.goods_id||o._id||"",goods_sku_id:o.goods_sku_id||o.sku_id||"",goods_no:o.goods_no||o.code||"",goods_img:o.goods_img||o.img||"",goods_name:o.goods_name||o.name||"",goods_spec:o.goods_spec||o.spec||"",goods_cnt:o.goods_cnt||e.goods_cnt||0,goods_unit:o.goods_unit||o.unit||"",goods_ori_price:o.goods_ori_price||t||0,goods_rate:o.goods_rate||100,goods_price:t,total_money:o.total_money||0,remark:o.remark||e.remark||""};return s},changeItemGoodsName(o,e){e.goods_name=o,e.goods_cnt=e.goods_cnt||1},changeItemGoods(o,e){e.goodsId||(o.goods?(Object.assign(e,this.formatItemGoods(o.goods,{remark:e.remark,goods_cnt:1})),this.initGoodsUnit(o.goods),this.changeOrdersCompleted()):Object(n["a"])("goods/getInfo",{goods_id:e.goods_id},{functionName:"xunda"}).then(o=>{const t=Object.assign(e,this.formatItemGoods(o.data,{remark:e.remark,goods_cnt:1}));this.initGoodsUnit(t),this.changeOrdersCompleted()}),o.others&&o.others.length>0&&(o.others.forEach(o=>{const e=this.formatItemGoods(Object.assign(o,{remark:o.remark,goods_cnt:1}));this.goodsList.push(e)}),this.changeOrdersCompleted()))},getItemGoodsUnitOptions(o){if(!o){const o=this.dictionary.goodsUnits.map(o=>({unit:o.name,value:o.name}));return[{label:"选择单位",children:o}]}const e=this.goodsUnitMap[o]||[];if(0===e.length)return[];const t=[{label:"默认单位",children:e.filter(o=>1===o.scale)}],s=e.filter(o=>1!==o.scale);return s.length>0&&t.push({label:"辅助单位",children:s}),t},remoteItemGoodsUnitMethod(o){if(!o.goods_id)return;const e=this.goodsUnitMap[o.goods_id]||[];e.length>1||Object(n["a"])("goods/getInfo",{goods_id:o.goods_id},{functionName:"xunda"}).then(o=>{const e=o.data;this.goodsUnitMap[e._id]=e.unit_list,Object(a["f"])(e),this.goodsList=[...this.goodsList]})},changeItemGoodsUnit(o){if(!o.goods_id)return;const e=this.goodsUnitMap[o.goods_id]||[],t=e.filter(e=>e.unit===o.goods_unit);if(0===t.length)return;const s=t[0],i=Object(a["b"])(o.goods_id);if(!i)return;let n=v["a"].mul(i.price,s.scale);const d=i.sku_datas.filter(e=>e.name===o.goods_spec);if(d.length>0){const e=d.filter(e=>e.unit===o.goods_unit);e.length>0&&(n=e[0].price||0)}const r=Number(n/100);o.goods_ori_price=r.toFixed(2);const l=v["a"].div(o.goods_rate||0,100).toFixed(2);o.goods_price=o.goods_ori_price*l,o.goods_rate=Number(o.goods_rate).toFixed(2),this.changeOrdersCompleted()},changeItemGoodsOriPrice(o){const e=Number(o.goods_ori_price||0),t=Number(o.goods_rate||0);o.goods_price=e*(t/100),this.changeOrdersCompleted()},changeItemGoodsRate(o){const e=Number(o.goods_ori_price||0),t=Math.max(Math.min(100,Number(o.goods_rate||0)),0);o.goods_rate=t.toFixed(2),o.goods_price=e*(o.goods_rate/100),this.changeOrdersCompleted()},changeItemGoodsPrice(o){const e=Number(o.goods_ori_price||0),t=Math.min(Number(o.goods_ori_price||0),Number(o.goods_price||0));o.goods_price=t.toFixed(2),o.goods_rate=(t/e*100).toFixed(2),this.changeOrdersCompleted()},changeOrdersCompleted(){this.goodsList.forEach(o=>{o.goods_ori_price=Number(o.goods_ori_price||0).toFixed(2),o.goods_cnt=Number(o.goods_cnt||0),o.goods_price=Number(o.goods_price||0).toFixed(2),o.total_ori_money=(o.goods_cnt*o.goods_ori_price).toFixed(2),o.total_money=(o.goods_cnt*o.goods_price).toFixed(2)}),this.goodsTotalCount=this.goodsList.reduce((o,e)=>o+e.goods_cnt,0),this.goodsOriginalMoney=this.goodsList.reduce((o,e)=>o+Number(e.total_ori_money),0),this.goodsTotalMoney=this.goodsList.reduce((o,e)=>o+Number(e.total_money),0),this.goodsDiscountMoney=this.goodsOriginalMoney-this.goodsTotalMoney,this.$emit("change")},getSummaryData(){return{goodsTotalCount:this.goodsTotalCount,goodsOriginalMoney:this.goodsOriginalMoney,goodsDiscountMoney:this.goodsDiscountMoney,goodsTotalMoney:this.goodsTotalMoney}},getListData(){return this.goodsList.filter(o=>!!o.goods_name)},summaryMethod({columns:o,data:e}){const t=[];return o.forEach((o,s)=>{if(0===s)return void(t[s]="合计");if(!["goods_cnt","total_money"].includes(o.property))return void(t[s]=" ");const i=e.map(e=>Number(e[o.property]));i.every(o=>isNaN(o))?t[s]="":(t[s]=i.reduce((o,e)=>o+e,0),["total_money"].includes(o.property)&&(t[s]=t[s].toFixed(2)))}),t}}},O=C,G=(t("3c62"),Object(b["a"])(O,s,i,!1,null,null,null));e["a"]=G.exports},e64f:function(o,e,t){"use strict";t("f989")},f989:function(o,e,t){}}]);