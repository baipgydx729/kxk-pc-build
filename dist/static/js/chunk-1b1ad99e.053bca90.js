(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-1b1ad99e"],{"3eaa":function(t,e,o){},"8c65":function(t,e,o){"use strict";o.r(e);var s=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"app-container"},[o("div",{staticClass:"aux-card"},[o("div",{staticClass:"header"},[t._m(0),o("div",{staticClass:"right"},[o("el-button",{attrs:{type:"default",icon:"el-icon-tickets"}},[t._v("取消")]),o("el-button",{attrs:{type:"primary",icon:"el-icon-document-checked"},on:{click:t.handleSave}},[t._v("保存 (Ctrl+S)")])],1)]),o("div",{staticClass:"margin-top-sm"},[o("el-form",{ref:"baseForm",attrs:{"label-width":"90px","label-align":"left",inline:!0}},[o("div",{staticClass:"dflex-s"},[o("el-form-item",{attrs:{label:"入库存日期"}},[o("el-date-picker",{staticStyle:{width:"300px"},attrs:{type:"datetime","value-format":"timestamp",clearable:!1},model:{value:t.baseForm.opt_time,callback:function(e){t.$set(t.baseForm,"opt_time",e)},expression:"baseForm.opt_time"}})],1),o("el-form-item",{attrs:{label:"入库类型"}},[o("el-select",{staticStyle:{width:"300px"},attrs:{placeholder:"选择入库类型"},model:{value:t.baseForm.opt_type,callback:function(e){t.$set(t.baseForm,"opt_type",e)},expression:"baseForm.opt_type"}},t._l(t.compTypeOptions,(function(t){return o("el-option",{key:t.value,attrs:{label:t.name,value:t.value}})})),1)],1),o("el-form-item",{attrs:{label:"入库仓库"}},[o("AuxWarehouseSelect",{staticStyle:{width:"300px"},model:{value:t.baseForm.warehouse_id,callback:function(e){t.$set(t.baseForm,"warehouse_id",e)},expression:"baseForm.warehouse_id"}})],1)],1)])],1),o("orders-goods-table",{ref:"goodsTable",on:{change:t.changeOrdersGoodsCompleted}})],1),o("el-card",{staticClass:"aux-card margin-top",attrs:{shadow:"none","body-style":{padding:"12px"}}},[o("div",{attrs:{slot:"header"},slot:"header"},[o("span",[t._v("备注信息")])]),o("el-input",{attrs:{type:"textarea",placeholder:"请填写备注内容",maxlength:"600","show-word-limit":""},model:{value:t.baseForm.remark,callback:function(e){t.$set(t.baseForm,"remark",e)},expression:"baseForm.remark"}})],1)],1)},a=[function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"left"},[o("span",{staticClass:"title"},[t._v("商品入库")])])}],i=(o("13d5"),function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"orders-goods-table"},[o("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.dataLoading,expression:"dataLoading"}],ref:"goodsTable",staticClass:"aux-table",attrs:{data:t.goodsList,border:"",fit:"","show-summary":"","summary-method":t.summaryMethod}},[o("el-table-column",{attrs:{type:"index",width:"50",align:"center",label:"序号"}}),o("el-table-column",{attrs:{width:"120",align:"center",label:"操作"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-button",{staticStyle:{padding:"6px 12px"},attrs:{type:"default",size:"mini",icon:"el-icon-plus",round:""},on:{click:function(o){return t.handleItemPlus(e.row,e.$index)}}}),o("el-button",{staticStyle:{padding:"6px 12px"},attrs:{type:"default",size:"mini",icon:"el-icon-minus",round:""},on:{click:function(o){return t.handleItemMinus(e.row,e.$index)}}})]}}])}),o("el-table-column",{attrs:{width:"280",align:"left",label:"商品名称"},scopedSlots:t._u([{key:"default",fn:function(e){return[e.row.goods_name?o("div",{staticClass:"dflex"},[o("div",{staticClass:"goods-img"},[o("img",{attrs:{src:e.row.goods_img||"/static/img/img-empty.png",alt:""}})]),o("div",{staticClass:"flex1"},[o("div",[t._v(t._s(e.row.goods_name))]),e.row.goods_no?o("div",{staticClass:"fs-xs ft-grey"},[t._v("No："+t._s(e.row.goods_no))]):t._e()])]):o("div",[o("AuxGoodsSelectPopoer",{attrs:{"main-price":"bid_price"},on:{change:function(o){return t.changeItemGoods(o,e.row)}},model:{value:e.row.goods_id,callback:function(o){t.$set(e.row,"goods_id",o)},expression:"scope.row.goods_id"}})],1)]}}])}),o("el-table-column",{attrs:{width:"200",align:"left",label:"规格/属性"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("span",[t._v(t._s(e.row.goods_spec))])]}}])}),o("el-table-column",{attrs:{width:"130",align:"center",label:"单位"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-select",{attrs:{disabled:!e.row.goods_name,placeholder:"单位"},on:{focus:function(o){return t.remoteItemGoodsUnitMethod(e.row)},change:function(o){return t.changeItemGoodsUnit(e.row)}},model:{value:e.row.goods_unit,callback:function(o){t.$set(e.row,"goods_unit",o)},expression:"scope.row.goods_unit"}},t._l(t.getItemGoodsUnitOptions(e.row.goods_id),(function(e){return o("el-option-group",{key:e.label,attrs:{label:e.label}},t._l(e.children,(function(e){return o("el-option",{key:e.unit,attrs:{label:e.unit+(e.unit_desc||""),value:e.unit}},[o("span",[t._v(t._s(e.unit)+t._s(e.unit_desc))])])})),1)})),1)]}}])}),o("el-table-column",{attrs:{width:"120",align:"center",label:"数量",prop:"goods_cnt"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-input",{staticClass:"tac",attrs:{disabled:!e.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"数量"},on:{blur:t.changeOrdersCompleted},model:{value:e.row.goods_cnt,callback:function(o){t.$set(e.row,"goods_cnt",o)},expression:"scope.row.goods_cnt"}})]}}])}),o("el-table-column",{attrs:{width:"120",align:"right",label:"单价(元)"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-input",{staticClass:"tar",attrs:{disabled:!e.row.goods_name,oninput:"value=value.match(/^\\d+(?:\\.\\d{0,2})?/)",onfocus:"this.select();",placeholder:"单价"},on:{blur:function(o){return t.changeItemGoodsPrice(e.row)}},model:{value:e.row.goods_price,callback:function(o){t.$set(e.row,"goods_price",o)},expression:"scope.row.goods_price"}})]}}])}),o("el-table-column",{attrs:{width:"120",align:"right",label:"金额小计(元)",prop:"total_money"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(e.row.total_money))]}}])}),o("el-table-column",{attrs:{align:"left",label:"备注","show-overflow-tooltip":""},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-popover",{attrs:{placement:"top-start",title:"编辑备注信息",width:"300",trigger:"click"}},[o("el-input",{attrs:{type:"textarea",rows:2,placeholder:"请输入备注"},model:{value:e.row.remark,callback:function(o){t.$set(e.row,"remark",o)},expression:"scope.row.remark"}}),o("span",{staticClass:"link-hover ft-primary",attrs:{slot:"reference"},slot:"reference"},[t._v(" "+t._s(e.row.remark||"编辑")+" ")])],1)]}}])})],1),o("div",{staticClass:"dflex-b padding"},[o("div",{staticClass:"dflex-s"},[o("el-button",{attrs:{type:"primary",size:"small",icon:"el-icon-plus"},on:{click:t.handleSelectAdd}},[t._v("选择商品")]),t.scanForm.visible?o("el-input",{ref:"scanInput",staticClass:"margin-lr-sm",staticStyle:{width:"260px"},attrs:{clearable:"",size:"small",placeholder:"请扫描商品编码或条形码"},nativeOn:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleScanAdd(e)}},model:{value:t.scanForm.keyword,callback:function(e){t.$set(t.scanForm,"keyword",e)},expression:"scanForm.keyword"}}):t._e(),o("el-button",{attrs:{type:"default",size:"small",icon:"el-icon-full-screen"},on:{click:t.handleScanOpen}},[t._v(" "+t._s(t.scanForm.visible?"取消扫码":"扫码录入")+" ")])],1),o("div",{staticClass:"dflex-e"},[o("span",{staticClass:"padding-left-lg"},[t._v("商品数量："+t._s(t.goodsTotalCount))]),o("span",{staticClass:"padding-left-lg"},[t._v("商品总额："+t._s(t.goodsTotalMoney.toFixed(2)))])])]),o("AuxGoodsSelectDialog",{ref:"auxGoodsSelectDialog",attrs:{"main-price":"bid_price"},on:{onSuccess:t.selectedGoodsSuccess}})],1)}),n=[],r=o("2197"),d=o("c031"),l=o("b122"),c=o("15f6"),u=o("e5bb"),m={components:{AuxGoodsSelectPopoer:c["a"],AuxGoodsSelectDialog:l["a"]},data(){return{dataLoading:!1,goodsList:[this.formatItemGoods()],goodsSelectIds:[],goodsSaleGrade:0,goodsTotalCount:0,goodsOriginalMoney:0,goodsDiscountMoney:0,goodsTotalMoney:0,goodsUnitMap:{},scanForm:{visible:!1,keyword:""}}},methods:{initData(t){this.goodsList=t.map(t=>this.formatItemGoods(t)),this.changeOrdersCompleted()},handleScanOpen(){this.scanForm.visible=!this.scanForm.visible,this.scanForm.visible&&this.$nextTick(()=>{this.$refs.scanInput.focus()})},handleScanAdd(){const t=this.scanForm.keyword.trim();t&&(this.scanForm.keyword="",Object(r["a"])("goods/getGoodsByCode",{code:t},{functionName:"xunda"}).then(t=>{const e=this.formatItemGoods(t.data,{remark:"",goods_cnt:1});this.initGoodsUnit(e),this.goodsList.push(e)}))},handleSelectAdd(){this.$refs.auxGoodsSelectDialog.open()},selectedGoodsSuccess(t){t.forEach(t=>{this.initGoodsUnit(t),this.goodsList.push(this.formatItemGoods(t,{remark:"",goods_cnt:t.goods_cnt}))}),this.changeOrdersCompleted()},handleItemPlus(t,e){this.goodsList.splice(e+1,0,this.formatItemGoods())},handleItemMinus(t,e){this.goodsList.splice(e,1),0===this.goodsList.length&&this.goodsList.push(this.formatItemGoods()),this.changeOrdersCompleted()},initGoodsUnit(t){this.goodsUnitMap[t._id]=t.unit_list||[]},formatItemGoods(t={},e={}){const o=t.goods_price||(t.bid_price||0)/100,s={goods_id:t.goods_id||t._id||"",goods_sku_id:t.goods_sku_id||t.sku_id||"",goods_no:t.goods_no||t.code||"",goods_img:t.goods_img||t.img||"",goods_name:t.goods_name||t.name||"",goods_spec:t.goods_spec||t.spec||"",goods_cnt:t.goods_cnt||e.goods_cnt||0,goods_unit:t.goods_unit||t.unit||"",goods_price:o,total_money:t.total_money||0,remark:t.remark||e.remark||""};return s},changeItemGoods(t,e){e.goodsId||(t.goods?(Object.assign(e,this.formatItemGoods(t.goods,{remark:e.remark,goods_cnt:1})),this.initGoodsUnit(t.goods),this.changeOrdersCompleted()):Object(r["a"])("goods/getInfo",{goods_id:e.goods_id},{functionName:"xunda"}).then(t=>{const o=Object.assign(e,this.formatItemGoods(t.data,{remark:e.remark,goods_cnt:1}));this.initGoodsUnit(o),this.changeOrdersCompleted()}))},getItemGoodsUnitOptions(t){if(!t)return[];const e=this.goodsUnitMap[t]||[];if(0===e.length)return[];const o=[{label:"默认单位",children:e.filter(t=>1===t.scale)}],s=e.filter(t=>1!==t.scale);return s.length>0&&o.push({label:"辅助单位",children:s}),o},remoteItemGoodsUnitMethod(t){if(!t.goods_id)return;const e=this.goodsUnitMap[t.goods_id]||[];e.length>1||Object(r["a"])("goods/getInfo",{goods_id:t.goods_id},{functionName:"xunda"}).then(t=>{const e=t.data;this.goodsUnitMap[e._id]=e.unit_list,Object(d["f"])(e),this.goodsList=[...this.goodsList]})},changeItemGoodsUnit(t){if(!t.goods_id)return;const e=this.goodsUnitMap[t.goods_id]||[],o=e.filter(e=>e.unit===t.goods_unit);if(0===o.length)return;const s=o[0],a=Object(d["b"])(t.goods_id);if(!a)return;let i=u["a"].mul(a.bid_price,s.scale);const n=a.sku_datas.filter(e=>e.name===t.goods_spec);if(n.length>0){const e=n.filter(e=>e.unit===t.goods_unit);e.length>0&&(i=e[0].bid_price||0)}const r=Number(i/100);t.goods_price=r,this.changeOrdersCompleted()},changeItemGoodsPrice(t){this.changeOrdersCompleted()},changeOrdersCompleted(){this.goodsList.forEach(t=>{t.goods_cnt=Number(t.goods_cnt||0),t.goods_price=Number(t.goods_price||0).toFixed(2),t.total_money=(t.goods_cnt*t.goods_price).toFixed(2)}),this.goodsTotalCount=this.goodsList.reduce((t,e)=>t+e.goods_cnt,0),this.goodsTotalMoney=this.goodsList.reduce((t,e)=>t+Number(e.total_money),0),this.goodsDiscountMoney=this.goodsOriginalMoney-this.goodsTotalMoney,this.$emit("change")},getSummaryData(){return{goodsTotalCount:this.goodsTotalCount,goodsDiscountMoney:this.goodsDiscountMoney,goodsTotalMoney:this.goodsTotalMoney}},getListData(){return this.goodsList.filter(t=>!!t.goods_name)},summaryMethod({columns:t,data:e}){const o=[];return t.forEach((t,s)=>{if(0===s)return void(o[s]="合计");if(!["goods_cnt","total_money"].includes(t.property))return void(o[s]=" ");const a=e.map(e=>Number(e[t.property]));a.every(t=>isNaN(t))?o[s]="":(o[s]=a.reduce((t,e)=>t+e,0),["total_money"].includes(t.property)&&(o[s]=o[s].toFixed(2)))}),o}}},g=m,p=(o("ab2d"),o("2877")),h=Object(p["a"])(g,i,n,!1,null,null,null),_=h.exports,f=o("c3dd"),b={components:{"orders-goods-table":_,AuxWarehouseSelect:f["a"]},data(){return{permission:"into-stock",ordersId:"",baseForm:{opt_time:(new Date).getTime(),opt_no:"",opt_type:1,orders_goods:[],remark:"",create_uname:"",goods_total_count:0,goods_total_money:0,total_price:0}}},computed:{compTypeOptions(){return this.$constant.STOCK_OPT_TYPES.filter(t=>[1,9].includes(t.value))}},methods:{changeOrdersGoodsCompleted(){const{goodsTotalCount:t=0,goodsTotalMoney:e=0}=this.$refs.goodsTable.getSummaryData();this.baseForm.goods_total_count=t,this.baseForm.goods_total_money=e,this.changeOrdersCompleted()},changeOrdersCompleted(){const t=this.getOrdersGoods(),e=t.reduce((t,e)=>t+e.total_money,0);this.baseForm.total_price=e},validateForm(){if(!this.baseForm.opt_time)return void this.$message.error("请填写入库日期");if(!this.baseForm.opt_type)return void this.$message.error("请填选择入库方式");if(!this.baseForm.warehouse_id)return void this.$message.error("请选择存放的仓库");const t=this.$refs.goodsTable.getListData();if(0!==t.length)return!0;this.$message.error("商品清单为空")},handleSave(){this.validateForm()&&this.submitForm(!1)},async submitForm(){const t=this.getOrdersData();Object(r["a"])("stock/intoOrders",t,{functionName:"xunda"}).then(t=>{this.$message("保存成功"),setTimeout(()=>{this.$router.push({path:"./stock-orders-detail/"+t.data})},500)},t=>{this.$message.error(t.message)})},getOrdersData(){const t=Object.assign({},this.baseForm,{opt_time:this.baseForm.opt_time,opt_type:this.baseForm.opt_type,warehouse_id:this.baseForm.warehouse_id,remark:this.baseForm.remark,orders_goods:this.getOrdersGoods(),total_price:this.baseForm.total_price,create_uname:this.$store.getters.companyInfo.member_name});return t},getOrdersGoods(){const t=this.$refs.goodsTable.getListData();return t.map(t=>{const e=Object.assign({},t);return e.goods_price=100*Number(t.goods_price).toFixed(2),e.total_money=Number(t.goods_cnt)*Number(e.goods_price),e})}}},y=b,v=Object(p["a"])(y,s,a,!1,null,null,null);e["default"]=v.exports},ab2d:function(t,e,o){"use strict";o("3eaa")}}]);